/*
 * ADAMAH - GPU Memory Maps + Vector Math
 * Unified implementation with embedded SPIR-V shaders
 * 
 * SPDX-License-Identifier: AGPL-3.0-or-later
 * Copyright (C) 2026 Sam (Samuele), Busto Arsizio, Italy
 * 
 * Publication Date: January 11, 2026
 * 
 * =============================================================================
 * DEFENSIVE DISCLOSURE & PRIOR ART DECLARATION
 * =============================================================================
 * 
 * This source code constitutes a Defensive Publication establishing Prior Art
 * for the following technical innovations:
 * 
 * 1. VULKAN SCATTER/GATHER FOR ML MEMORY MAPS
 *    - VkBuffer with HOST_VISIBLE|HOST_COHERENT for zero-copy CPU↔GPU access
 *    - VkSpecializationConstant for parameterized WORDS_PER_ELEM (4,8,16,32 bytes)
 *    - Descriptor binding pattern: locs(0), src(1), dst(2) for scatter; 
 *      locs(0), map(1), out(2) for gather
 * 
 * 2. SPARSE NEURAL NETWORK REPRESENTATION
 *    - Implicit zero-default: non-existent entries return 0 without storage
 *    - Pack-based addressing: total_elems = pack_size * n_packs (power-of-2)
 *    - Direct binary persistence via fwrite/fread on mapped memory
 * 
 * 3. SPIR-V SHADER ARCHITECTURE
 *    - OpTypePointer StorageBuffer with NonWritable decoration for gather
 *    - Shared memory parallel reduction (256 threads, tree pattern)
 *    - Push constant {count, op} encoding for operation dispatch
 *    - Switch-based op selection: ADD=0, SUB=1, MUL=2, DIV=3
 *    - Extended unary: NEG=10, ABS=11, SQRT=12, EXP=13, LOG=14, TANH=15,
 *      RELU=16, GELU=17, SIN=18, COS=19, RECIP=20, SQR=21, COPY=22
 * 
 * Any patent application covering these techniques should be REJECTED FOR
 * LACK OF NOVELTY under 35 U.S.C. § 102 (US), Article 54 EPC (EU), and
 * equivalent provisions worldwide.
 * 
 * =============================================================================
 */

#include "adamah.h"
#include <vulkan/vulkan.h>
#include <string.h>
#include <stdlib.h>
#include <stdio.h>
#include <math.h>

#define ADAMAH_MAX_MAPS 16
#define ADAMAH_MAX_VBUFS 64
#define LOCAL_SIZE 256

// ============================================
// Embedded SPIR-V Shaders
// ============================================

// scatter.comp - write vals[i] to map[locs[i]]
static const uint32_t shader_scatter[] = {
    0x07230203, 0x00010000, 0x000d000b, 0x0000004f, 0x00000000, 0x00020011, 0x00000001, 0x0006000b,
    0x00000001, 0x4c534c47, 0x6474732e, 0x3035342e, 0x00000000, 0x0003000e, 0x00000000, 0x00000001,
    0x0006000f, 0x00000005, 0x00000004, 0x6e69616d, 0x00000000, 0x0000000b, 0x00060010, 0x00000004,
    0x00000011, 0x00000100, 0x00000001, 0x00000001, 0x00030003, 0x00000002, 0x000001c2, 0x000a0004,
    0x475f4c47, 0x4c474f4f, 0x70635f45, 0x74735f70, 0x5f656c79, 0x656e696c, 0x7269645f, 0x69746365,
    0x00006576, 0x00080004, 0x475f4c47, 0x4c474f4f, 0x6e695f45, 0x64756c63, 0x69645f65, 0x74636572,
    0x00657669, 0x00040005, 0x00000004, 0x6e69616d, 0x00000000, 0x00030005, 0x00000008, 0x00646967,
    0x00080005, 0x0000000b, 0x475f6c67, 0x61626f6c, 0x766e496c, 0x7461636f, 0x496e6f69, 0x00000044,
    0x00040005, 0x00000011, 0x68737550, 0x00000000, 0x00050006, 0x00000011, 0x00000000, 0x6e756f63,
    0x00000074, 0x00030005, 0x00000013, 0x00006370, 0x00030005, 0x0000001e, 0x00636f6c, 0x00040005,
    0x00000020, 0x73636f4c, 0x00000000, 0x00050006, 0x00000020, 0x00000000, 0x61746164, 0x00000000,
    0x00040005, 0x00000022, 0x73636f6c, 0x00000000, 0x00030005, 0x00000029, 0x00747364, 0x00060005,
    0x0000002b, 0x44524f57, 0x45505f53, 0x4c455f52, 0x00004d45, 0x00030005, 0x0000002d, 0x00637273,
    0x00030005, 0x00000030, 0x00000077, 0x00030005, 0x00000039, 0x0070614d, 0x00050006, 0x00000039,
    0x00000000, 0x61746164, 0x00000000, 0x00050005, 0x0000003b, 0x5f70616d, 0x61746164, 0x00000000,
    0x00040005, 0x00000040, 0x736c6156, 0x00000000, 0x00050006, 0x00000040, 0x00000000, 0x61746164,
    0x00000000, 0x00040005, 0x00000042, 0x736c6176, 0x00000000, 0x00040047, 0x0000000b, 0x0000000b,
    0x0000001c, 0x00050048, 0x00000011, 0x00000000, 0x00000023, 0x00000000, 0x00030047, 0x00000011,
    0x00000002, 0x00040047, 0x0000001f, 0x00000006, 0x00000004, 0x00040048, 0x00000020, 0x00000000,
    0x00000018, 0x00050048, 0x00000020, 0x00000000, 0x00000023, 0x00000000, 0x00030047, 0x00000020,
    0x00000003, 0x00040047, 0x00000022, 0x00000022, 0x00000000, 0x00040047, 0x00000022, 0x00000021,
    0x00000000, 0x00040047, 0x0000002b, 0x00000001, 0x00000000, 0x00040047, 0x00000038, 0x00000006,
    0x00000004, 0x00050048, 0x00000039, 0x00000000, 0x00000023, 0x00000000, 0x00030047, 0x00000039,
    0x00000003, 0x00040047, 0x0000003b, 0x00000022, 0x00000000, 0x00040047, 0x0000003b, 0x00000021,
    0x00000002, 0x00040047, 0x0000003f, 0x00000006, 0x00000004, 0x00040048, 0x00000040, 0x00000000,
    0x00000018, 0x00050048, 0x00000040, 0x00000000, 0x00000023, 0x00000000, 0x00030047, 0x00000040,
    0x00000003, 0x00040047, 0x00000042, 0x00000022, 0x00000000, 0x00040047, 0x00000042, 0x00000021,
    0x00000001, 0x00040047, 0x0000004e, 0x0000000b, 0x00000019, 0x00020013, 0x00000002, 0x00030021,
    0x00000003, 0x00000002, 0x00040015, 0x00000006, 0x00000020, 0x00000000, 0x00040020, 0x00000007,
    0x00000007, 0x00000006, 0x00040017, 0x00000009, 0x00000006, 0x00000003, 0x00040020, 0x0000000a,
    0x00000001, 0x00000009, 0x0004003b, 0x0000000a, 0x0000000b, 0x00000001, 0x0004002b, 0x00000006,
    0x0000000c, 0x00000000, 0x00040020, 0x0000000d, 0x00000001, 0x00000006, 0x0003001e, 0x00000011,
    0x00000006, 0x00040020, 0x00000012, 0x00000009, 0x00000011, 0x0004003b, 0x00000012, 0x00000013,
    0x00000009, 0x00040015, 0x00000014, 0x00000020, 0x00000001, 0x0004002b, 0x00000014, 0x00000015,
    0x00000000, 0x00040020, 0x00000016, 0x00000009, 0x00000006, 0x00020014, 0x00000019, 0x0003001d,
    0x0000001f, 0x00000006, 0x0003001e, 0x00000020, 0x0000001f, 0x00040020, 0x00000021, 0x00000002,
    0x00000020, 0x0004003b, 0x00000021, 0x00000022, 0x00000002, 0x0004002b, 0x00000006, 0x00000024,
    0x00000002, 0x00040020, 0x00000026, 0x00000002, 0x00000006, 0x00040032, 0x00000006, 0x0000002b,
    0x00000001, 0x0003001d, 0x00000038, 0x00000006, 0x0003001e, 0x00000039, 0x00000038, 0x00040020,
    0x0000003a, 0x00000002, 0x00000039, 0x0004003b, 0x0000003a, 0x0000003b, 0x00000002, 0x0003001d,
    0x0000003f, 0x00000006, 0x0003001e, 0x00000040, 0x0000003f, 0x00040020, 0x00000041, 0x00000002,
    0x00000040, 0x0004003b, 0x00000041, 0x00000042, 0x00000002, 0x0004002b, 0x00000014, 0x0000004a,
    0x00000001, 0x0004002b, 0x00000006, 0x0000004c, 0x00000100, 0x0004002b, 0x00000006, 0x0000004d,
    0x00000001, 0x0006002c, 0x00000009, 0x0000004e, 0x0000004c, 0x0000004d, 0x0000004d, 0x00050036,
    0x00000002, 0x00000004, 0x00000000, 0x00000003, 0x000200f8, 0x00000005, 0x0004003b, 0x00000007,
    0x00000008, 0x00000007, 0x0004003b, 0x00000007, 0x0000001e, 0x00000007, 0x0004003b, 0x00000007,
    0x00000029, 0x00000007, 0x0004003b, 0x00000007, 0x0000002d, 0x00000007, 0x0004003b, 0x00000007,
    0x00000030, 0x00000007, 0x00050041, 0x0000000d, 0x0000000e, 0x0000000b, 0x0000000c, 0x0004003d,
    0x00000006, 0x0000000f, 0x0000000e, 0x0003003e, 0x00000008, 0x0000000f, 0x0004003d, 0x00000006,
    0x00000010, 0x00000008, 0x00050041, 0x00000016, 0x00000017, 0x00000013, 0x00000015, 0x0004003d,
    0x00000006, 0x00000018, 0x00000017, 0x000500ae, 0x00000019, 0x0000001a, 0x00000010, 0x00000018,
    0x000300f7, 0x0000001c, 0x00000000, 0x000400fa, 0x0000001a, 0x0000001b, 0x0000001c, 0x000200f8,
    0x0000001b, 0x000100fd, 0x000200f8, 0x0000001c, 0x0004003d, 0x00000006, 0x00000023, 0x00000008,
    0x00050084, 0x00000006, 0x00000025, 0x00000023, 0x00000024, 0x00060041, 0x00000026, 0x00000027,
    0x00000022, 0x00000015, 0x00000025, 0x0004003d, 0x00000006, 0x00000028, 0x00000027, 0x0003003e,
    0x0000001e, 0x00000028, 0x0004003d, 0x00000006, 0x0000002a, 0x0000001e, 0x00050084, 0x00000006,
    0x0000002c, 0x0000002a, 0x0000002b, 0x0003003e, 0x00000029, 0x0000002c, 0x0004003d, 0x00000006,
    0x0000002e, 0x00000008, 0x00050084, 0x00000006, 0x0000002f, 0x0000002e, 0x0000002b, 0x0003003e,
    0x0000002d, 0x0000002f, 0x0003003e, 0x00000030, 0x0000000c, 0x000200f9, 0x00000031, 0x000200f8,
    0x00000031, 0x000400f6, 0x00000033, 0x00000034, 0x00000000, 0x000200f9, 0x00000035, 0x000200f8,
    0x00000035, 0x0004003d, 0x00000006, 0x00000036, 0x00000030, 0x000500b0, 0x00000019, 0x00000037,
    0x00000036, 0x0000002b, 0x000400fa, 0x00000037, 0x00000032, 0x00000033, 0x000200f8, 0x00000032,
    0x0004003d, 0x00000006, 0x0000003c, 0x00000029, 0x0004003d, 0x00000006, 0x0000003d, 0x00000030,
    0x00050080, 0x00000006, 0x0000003e, 0x0000003c, 0x0000003d, 0x0004003d, 0x00000006, 0x00000043,
    0x0000002d, 0x0004003d, 0x00000006, 0x00000044, 0x00000030, 0x00050080, 0x00000006, 0x00000045,
    0x00000043, 0x00000044, 0x00060041, 0x00000026, 0x00000046, 0x00000042, 0x00000015, 0x00000045,
    0x0004003d, 0x00000006, 0x00000047, 0x00000046, 0x00060041, 0x00000026, 0x00000048, 0x0000003b,
    0x00000015, 0x0000003e, 0x0003003e, 0x00000048, 0x00000047, 0x000200f9, 0x00000034, 0x000200f8,
    0x00000034, 0x0004003d, 0x00000006, 0x00000049, 0x00000030, 0x00050080, 0x00000006, 0x0000004b,
    0x00000049, 0x0000004a, 0x0003003e, 0x00000030, 0x0000004b, 0x000200f9, 0x00000031, 0x000200f8,
    0x00000033, 0x000100fd, 0x00010038,
};

// gather.comp - read map[locs[i]] into out[i]
static const uint32_t shader_gather[] = {
    0x07230203, 0x00010000, 0x000d000b, 0x0000004f, 0x00000000, 0x00020011, 0x00000001, 0x0006000b,
    0x00000001, 0x4c534c47, 0x6474732e, 0x3035342e, 0x00000000, 0x0003000e, 0x00000000, 0x00000001,
    0x0006000f, 0x00000005, 0x00000004, 0x6e69616d, 0x00000000, 0x0000000b, 0x00060010, 0x00000004,
    0x00000011, 0x00000100, 0x00000001, 0x00000001, 0x00030003, 0x00000002, 0x000001c2, 0x000a0004,
    0x475f4c47, 0x4c474f4f, 0x70635f45, 0x74735f70, 0x5f656c79, 0x656e696c, 0x7269645f, 0x69746365,
    0x00006576, 0x00080004, 0x475f4c47, 0x4c474f4f, 0x6e695f45, 0x64756c63, 0x69645f65, 0x74636572,
    0x00657669, 0x00040005, 0x00000004, 0x6e69616d, 0x00000000, 0x00030005, 0x00000008, 0x00646967,
    0x00080005, 0x0000000b, 0x475f6c67, 0x61626f6c, 0x766e496c, 0x7461636f, 0x496e6f69, 0x00000044,
    0x00040005, 0x00000011, 0x68737550, 0x00000000, 0x00050006, 0x00000011, 0x00000000, 0x6e756f63,
    0x00000074, 0x00030005, 0x00000013, 0x00006370, 0x00030005, 0x0000001e, 0x00636f6c, 0x00040005,
    0x00000020, 0x73636f4c, 0x00000000, 0x00050006, 0x00000020, 0x00000000, 0x61746164, 0x00000000,
    0x00040005, 0x00000022, 0x73636f6c, 0x00000000, 0x00030005, 0x00000029, 0x00637273, 0x00060005,
    0x0000002b, 0x44524f57, 0x45505f53, 0x4c455f52, 0x00004d45, 0x00030005, 0x0000002d, 0x00747364,
    0x00030005, 0x00000030, 0x00000077, 0x00030005, 0x00000039, 0x0074754f, 0x00050006, 0x00000039,
    0x00000000, 0x61746164, 0x00000000, 0x00050005, 0x0000003b, 0x5f74756f, 0x61746164, 0x00000000,
    0x00030005, 0x00000040, 0x0070614d, 0x00050006, 0x00000040, 0x00000000, 0x61746164, 0x00000000,
    0x00050005, 0x00000042, 0x5f70616d, 0x61746164, 0x00000000, 0x00040047, 0x0000000b, 0x0000000b,
    0x0000001c, 0x00050048, 0x00000011, 0x00000000, 0x00000023, 0x00000000, 0x00030047, 0x00000011,
    0x00000002, 0x00040047, 0x0000001f, 0x00000006, 0x00000004, 0x00040048, 0x00000020, 0x00000000,
    0x00000018, 0x00050048, 0x00000020, 0x00000000, 0x00000023, 0x00000000, 0x00030047, 0x00000020,
    0x00000003, 0x00040047, 0x00000022, 0x00000022, 0x00000000, 0x00040047, 0x00000022, 0x00000021,
    0x00000000, 0x00040047, 0x0000002b, 0x00000001, 0x00000000, 0x00040047, 0x00000038, 0x00000006,
    0x00000004, 0x00050048, 0x00000039, 0x00000000, 0x00000023, 0x00000000, 0x00030047, 0x00000039,
    0x00000003, 0x00040047, 0x0000003b, 0x00000022, 0x00000000, 0x00040047, 0x0000003b, 0x00000021,
    0x00000002, 0x00040047, 0x0000003f, 0x00000006, 0x00000004, 0x00040048, 0x00000040, 0x00000000,
    0x00000018, 0x00050048, 0x00000040, 0x00000000, 0x00000023, 0x00000000, 0x00030047, 0x00000040,
    0x00000003, 0x00040047, 0x00000042, 0x00000022, 0x00000000, 0x00040047, 0x00000042, 0x00000021,
    0x00000001, 0x00040047, 0x0000004e, 0x0000000b, 0x00000019, 0x00020013, 0x00000002, 0x00030021,
    0x00000003, 0x00000002, 0x00040015, 0x00000006, 0x00000020, 0x00000000, 0x00040020, 0x00000007,
    0x00000007, 0x00000006, 0x00040017, 0x00000009, 0x00000006, 0x00000003, 0x00040020, 0x0000000a,
    0x00000001, 0x00000009, 0x0004003b, 0x0000000a, 0x0000000b, 0x00000001, 0x0004002b, 0x00000006,
    0x0000000c, 0x00000000, 0x00040020, 0x0000000d, 0x00000001, 0x00000006, 0x0003001e, 0x00000011,
    0x00000006, 0x00040020, 0x00000012, 0x00000009, 0x00000011, 0x0004003b, 0x00000012, 0x00000013,
    0x00000009, 0x00040015, 0x00000014, 0x00000020, 0x00000001, 0x0004002b, 0x00000014, 0x00000015,
    0x00000000, 0x00040020, 0x00000016, 0x00000009, 0x00000006, 0x00020014, 0x00000019, 0x0003001d,
    0x0000001f, 0x00000006, 0x0003001e, 0x00000020, 0x0000001f, 0x00040020, 0x00000021, 0x00000002,
    0x00000020, 0x0004003b, 0x00000021, 0x00000022, 0x00000002, 0x0004002b, 0x00000006, 0x00000024,
    0x00000002, 0x00040020, 0x00000026, 0x00000002, 0x00000006, 0x00040032, 0x00000006, 0x0000002b,
    0x00000001, 0x0003001d, 0x00000038, 0x00000006, 0x0003001e, 0x00000039, 0x00000038, 0x00040020,
    0x0000003a, 0x00000002, 0x00000039, 0x0004003b, 0x0000003a, 0x0000003b, 0x00000002, 0x0003001d,
    0x0000003f, 0x00000006, 0x0003001e, 0x00000040, 0x0000003f, 0x00040020, 0x00000041, 0x00000002,
    0x00000040, 0x0004003b, 0x00000041, 0x00000042, 0x00000002, 0x0004002b, 0x00000014, 0x0000004a,
    0x00000001, 0x0004002b, 0x00000006, 0x0000004c, 0x00000100, 0x0004002b, 0x00000006, 0x0000004d,
    0x00000001, 0x0006002c, 0x00000009, 0x0000004e, 0x0000004c, 0x0000004d, 0x0000004d, 0x00050036,
    0x00000002, 0x00000004, 0x00000000, 0x00000003, 0x000200f8, 0x00000005, 0x0004003b, 0x00000007,
    0x00000008, 0x00000007, 0x0004003b, 0x00000007, 0x0000001e, 0x00000007, 0x0004003b, 0x00000007,
    0x00000029, 0x00000007, 0x0004003b, 0x00000007, 0x0000002d, 0x00000007, 0x0004003b, 0x00000007,
    0x00000030, 0x00000007, 0x00050041, 0x0000000d, 0x0000000e, 0x0000000b, 0x0000000c, 0x0004003d,
    0x00000006, 0x0000000f, 0x0000000e, 0x0003003e, 0x00000008, 0x0000000f, 0x0004003d, 0x00000006,
    0x00000010, 0x00000008, 0x00050041, 0x00000016, 0x00000017, 0x00000013, 0x00000015, 0x0004003d,
    0x00000006, 0x00000018, 0x00000017, 0x000500ae, 0x00000019, 0x0000001a, 0x00000010, 0x00000018,
    0x000300f7, 0x0000001c, 0x00000000, 0x000400fa, 0x0000001a, 0x0000001b, 0x0000001c, 0x000200f8,
    0x0000001b, 0x000100fd, 0x000200f8, 0x0000001c, 0x0004003d, 0x00000006, 0x00000023, 0x00000008,
    0x00050084, 0x00000006, 0x00000025, 0x00000023, 0x00000024, 0x00060041, 0x00000026, 0x00000027,
    0x00000022, 0x00000015, 0x00000025, 0x0004003d, 0x00000006, 0x00000028, 0x00000027, 0x0003003e,
    0x0000001e, 0x00000028, 0x0004003d, 0x00000006, 0x0000002a, 0x0000001e, 0x00050084, 0x00000006,
    0x0000002c, 0x0000002a, 0x0000002b, 0x0003003e, 0x00000029, 0x0000002c, 0x0004003d, 0x00000006,
    0x0000002e, 0x00000008, 0x00050084, 0x00000006, 0x0000002f, 0x0000002e, 0x0000002b, 0x0003003e,
    0x0000002d, 0x0000002f, 0x0003003e, 0x00000030, 0x0000000c, 0x000200f9, 0x00000031, 0x000200f8,
    0x00000031, 0x000400f6, 0x00000033, 0x00000034, 0x00000000, 0x000200f9, 0x00000035, 0x000200f8,
    0x00000035, 0x0004003d, 0x00000006, 0x00000036, 0x00000030, 0x000500b0, 0x00000019, 0x00000037,
    0x00000036, 0x0000002b, 0x000400fa, 0x00000037, 0x00000032, 0x00000033, 0x000200f8, 0x00000032,
    0x0004003d, 0x00000006, 0x0000003c, 0x0000002d, 0x0004003d, 0x00000006, 0x0000003d, 0x00000030,
    0x00050080, 0x00000006, 0x0000003e, 0x0000003c, 0x0000003d, 0x0004003d, 0x00000006, 0x00000043,
    0x00000029, 0x0004003d, 0x00000006, 0x00000044, 0x00000030, 0x00050080, 0x00000006, 0x00000045,
    0x00000043, 0x00000044, 0x00060041, 0x00000026, 0x00000046, 0x00000042, 0x00000015, 0x00000045,
    0x0004003d, 0x00000006, 0x00000047, 0x00000046, 0x00060041, 0x00000026, 0x00000048, 0x0000003b,
    0x00000015, 0x0000003e, 0x0003003e, 0x00000048, 0x00000047, 0x000200f9, 0x00000034, 0x000200f8,
    0x00000034, 0x0004003d, 0x00000006, 0x00000049, 0x00000030, 0x00050080, 0x00000006, 0x0000004b,
    0x00000049, 0x0000004a, 0x0003003e, 0x00000030, 0x0000004b, 0x000200f9, 0x00000031, 0x000200f8,
    0x00000033, 0x000100fd, 0x00010038,
};

// ADAMAH Embedded SPIR-V Shaders - Auto-generated

// binary.spv - 2268 bytes
static const uint32_t shader_binary[] = {
    0x07230203, 0x00010000, 0x000d000b, 0x00000058, 0x00000000, 0x00020011, 0x00000001, 0x0006000b,
    0x00000001, 0x4c534c47, 0x6474732e, 0x3035342e, 0x00000000, 0x0003000e, 0x00000000, 0x00000001,
    0x0006000f, 0x00000005, 0x00000004, 0x6e69616d, 0x00000000, 0x0000000b, 0x00060010, 0x00000004,
    0x00000011, 0x00000100, 0x00000001, 0x00000001, 0x00030003, 0x00000002, 0x000001c2, 0x000a0004,
    0x475f4c47, 0x4c474f4f, 0x70635f45, 0x74735f70, 0x5f656c79, 0x656e696c, 0x7269645f, 0x69746365,
    0x00006576, 0x00080004, 0x475f4c47, 0x4c474f4f, 0x6e695f45, 0x64756c63, 0x69645f65, 0x74636572,
    0x00657669, 0x00040005, 0x00000004, 0x6e69616d, 0x00000000, 0x00030005, 0x00000008, 0x00646967,
    0x00080005, 0x0000000b, 0x475f6c67, 0x61626f6c, 0x766e496c, 0x7461636f, 0x496e6f69, 0x00000044,
    0x00040005, 0x00000011, 0x61726150, 0x0000736d, 0x00050006, 0x00000011, 0x00000000, 0x6e756f63,
    0x00000074, 0x00040006, 0x00000011, 0x00000001, 0x0000706f, 0x00030005, 0x00000013, 0x00000000,
    0x00030005, 0x00000020, 0x00006176, 0x00040005, 0x00000022, 0x41637253, 0x00000000, 0x00040006,
    0x00000022, 0x00000000, 0x00000061, 0x00030005, 0x00000024, 0x00000000, 0x00030005, 0x00000029,
    0x00006276, 0x00040005, 0x0000002b, 0x42637253, 0x00000000, 0x00040006, 0x0000002b, 0x00000000,
    0x00000062, 0x00030005, 0x0000002d, 0x00000000, 0x00040005, 0x0000003a, 0x75736572, 0x0000746c,
    0x00030005, 0x0000004f, 0x00747344, 0x00040006, 0x0000004f, 0x00000000, 0x00747364, 0x00030005,
    0x00000051, 0x00000000, 0x00040047, 0x0000000b, 0x0000000b, 0x0000001c, 0x00050048, 0x00000011,
    0x00000000, 0x00000023, 0x00000000, 0x00050048, 0x00000011, 0x00000001, 0x00000023, 0x00000004,
    0x00030047, 0x00000011, 0x00000002, 0x00040047, 0x00000021, 0x00000006, 0x00000004, 0x00050048,
    0x00000022, 0x00000000, 0x00000023, 0x00000000, 0x00030047, 0x00000022, 0x00000003, 0x00040047,
    0x00000024, 0x00000022, 0x00000000, 0x00040047, 0x00000024, 0x00000021, 0x00000001, 0x00040047,
    0x0000002a, 0x00000006, 0x00000004, 0x00050048, 0x0000002b, 0x00000000, 0x00000023, 0x00000000,
    0x00030047, 0x0000002b, 0x00000003, 0x00040047, 0x0000002d, 0x00000022, 0x00000000, 0x00040047,
    0x0000002d, 0x00000021, 0x00000002, 0x00040047, 0x0000004e, 0x00000006, 0x00000004, 0x00050048,
    0x0000004f, 0x00000000, 0x00000023, 0x00000000, 0x00030047, 0x0000004f, 0x00000003, 0x00040047,
    0x00000051, 0x00000022, 0x00000000, 0x00040047, 0x00000051, 0x00000021, 0x00000000, 0x00040047,
    0x00000057, 0x0000000b, 0x00000019, 0x00020013, 0x00000002, 0x00030021, 0x00000003, 0x00000002,
    0x00040015, 0x00000006, 0x00000020, 0x00000000, 0x00040020, 0x00000007, 0x00000007, 0x00000006,
    0x00040017, 0x00000009, 0x00000006, 0x00000003, 0x00040020, 0x0000000a, 0x00000001, 0x00000009,
    0x0004003b, 0x0000000a, 0x0000000b, 0x00000001, 0x0004002b, 0x00000006, 0x0000000c, 0x00000000,
    0x00040020, 0x0000000d, 0x00000001, 0x00000006, 0x0004001e, 0x00000011, 0x00000006, 0x00000006,
    0x00040020, 0x00000012, 0x00000009, 0x00000011, 0x0004003b, 0x00000012, 0x00000013, 0x00000009,
    0x00040015, 0x00000014, 0x00000020, 0x00000001, 0x0004002b, 0x00000014, 0x00000015, 0x00000000,
    0x00040020, 0x00000016, 0x00000009, 0x00000006, 0x00020014, 0x00000019, 0x00030016, 0x0000001e,
    0x00000020, 0x00040020, 0x0000001f, 0x00000007, 0x0000001e, 0x0003001d, 0x00000021, 0x0000001e,
    0x0003001e, 0x00000022, 0x00000021, 0x00040020, 0x00000023, 0x00000002, 0x00000022, 0x0004003b,
    0x00000023, 0x00000024, 0x00000002, 0x00040020, 0x00000026, 0x00000002, 0x0000001e, 0x0003001d,
    0x0000002a, 0x0000001e, 0x0003001e, 0x0000002b, 0x0000002a, 0x00040020, 0x0000002c, 0x00000002,
    0x0000002b, 0x0004003b, 0x0000002c, 0x0000002d, 0x00000002, 0x0004002b, 0x00000014, 0x00000031,
    0x00000001, 0x0004002b, 0x0000001e, 0x0000004b, 0x00000000, 0x0003001d, 0x0000004e, 0x0000001e,
    0x0003001e, 0x0000004f, 0x0000004e, 0x00040020, 0x00000050, 0x00000002, 0x0000004f, 0x0004003b,
    0x00000050, 0x00000051, 0x00000002, 0x0004002b, 0x00000006, 0x00000055, 0x00000100, 0x0004002b,
    0x00000006, 0x00000056, 0x00000001, 0x0006002c, 0x00000009, 0x00000057, 0x00000055, 0x00000056,
    0x00000056, 0x00050036, 0x00000002, 0x00000004, 0x00000000, 0x00000003, 0x000200f8, 0x00000005,
    0x0004003b, 0x00000007, 0x00000008, 0x00000007, 0x0004003b, 0x0000001f, 0x00000020, 0x00000007,
    0x0004003b, 0x0000001f, 0x00000029, 0x00000007, 0x0004003b, 0x0000001f, 0x0000003a, 0x00000007,
    0x00050041, 0x0000000d, 0x0000000e, 0x0000000b, 0x0000000c, 0x0004003d, 0x00000006, 0x0000000f,
    0x0000000e, 0x0003003e, 0x00000008, 0x0000000f, 0x0004003d, 0x00000006, 0x00000010, 0x00000008,
    0x00050041, 0x00000016, 0x00000017, 0x00000013, 0x00000015, 0x0004003d, 0x00000006, 0x00000018,
    0x00000017, 0x000500ae, 0x00000019, 0x0000001a, 0x00000010, 0x00000018, 0x000300f7, 0x0000001c,
    0x00000000, 0x000400fa, 0x0000001a, 0x0000001b, 0x0000001c, 0x000200f8, 0x0000001b, 0x000100fd,
    0x000200f8, 0x0000001c, 0x0004003d, 0x00000006, 0x00000025, 0x00000008, 0x00060041, 0x00000026,
    0x00000027, 0x00000024, 0x00000015, 0x00000025, 0x0004003d, 0x0000001e, 0x00000028, 0x00000027,
    0x0003003e, 0x00000020, 0x00000028, 0x0004003d, 0x00000006, 0x0000002e, 0x00000008, 0x00060041,
    0x00000026, 0x0000002f, 0x0000002d, 0x00000015, 0x0000002e, 0x0004003d, 0x0000001e, 0x00000030,
    0x0000002f, 0x0003003e, 0x00000029, 0x00000030, 0x00050041, 0x00000016, 0x00000032, 0x00000013,
    0x00000031, 0x0004003d, 0x00000006, 0x00000033, 0x00000032, 0x000300f7, 0x00000039, 0x00000000,
    0x000b00fb, 0x00000033, 0x00000038, 0x00000000, 0x00000034, 0x00000001, 0x00000035, 0x00000002,
    0x00000036, 0x00000003, 0x00000037, 0x000200f8, 0x00000038, 0x0003003e, 0x0000003a, 0x0000004b,
    0x000200f9, 0x00000039, 0x000200f8, 0x00000034, 0x0004003d, 0x0000001e, 0x0000003b, 0x00000020,
    0x0004003d, 0x0000001e, 0x0000003c, 0x00000029, 0x00050081, 0x0000001e, 0x0000003d, 0x0000003b,
    0x0000003c, 0x0003003e, 0x0000003a, 0x0000003d, 0x000200f9, 0x00000039, 0x000200f8, 0x00000035,
    0x0004003d, 0x0000001e, 0x0000003f, 0x00000020, 0x0004003d, 0x0000001e, 0x00000040, 0x00000029,
    0x00050083, 0x0000001e, 0x00000041, 0x0000003f, 0x00000040, 0x0003003e, 0x0000003a, 0x00000041,
    0x000200f9, 0x00000039, 0x000200f8, 0x00000036, 0x0004003d, 0x0000001e, 0x00000043, 0x00000020,
    0x0004003d, 0x0000001e, 0x00000044, 0x00000029, 0x00050085, 0x0000001e, 0x00000045, 0x00000043,
    0x00000044, 0x0003003e, 0x0000003a, 0x00000045, 0x000200f9, 0x00000039, 0x000200f8, 0x00000037,
    0x0004003d, 0x0000001e, 0x00000047, 0x00000020, 0x0004003d, 0x0000001e, 0x00000048, 0x00000029,
    0x00050088, 0x0000001e, 0x00000049, 0x00000047, 0x00000048, 0x0003003e, 0x0000003a, 0x00000049,
    0x000200f9, 0x00000039, 0x000200f8, 0x00000039, 0x0004003d, 0x00000006, 0x00000052, 0x00000008,
    0x0004003d, 0x0000001e, 0x00000053, 0x0000003a, 0x00060041, 0x00000026, 0x00000054, 0x00000051,
    0x00000015, 0x00000052, 0x0003003e, 0x00000054, 0x00000053, 0x000100fd, 0x00010038,
};

// unary.spv - 3072 bytes
static const uint32_t shader_unary[] = {
    0x07230203, 0x00010000, 0x000d000b, 0x00000089, 0x00000000, 0x00020011, 0x00000001, 0x0006000b,
    0x00000001, 0x4c534c47, 0x6474732e, 0x3035342e, 0x00000000, 0x0003000e, 0x00000000, 0x00000001,
    0x0006000f, 0x00000005, 0x00000004, 0x6e69616d, 0x00000000, 0x00000025, 0x00060010, 0x00000004,
    0x00000011, 0x00000100, 0x00000001, 0x00000001, 0x00030003, 0x00000002, 0x000001c2, 0x000a0004,
    0x475f4c47, 0x4c474f4f, 0x70635f45, 0x74735f70, 0x5f656c79, 0x656e696c, 0x7269645f, 0x69746365,
    0x00006576, 0x00080004, 0x475f4c47, 0x4c474f4f, 0x6e695f45, 0x64756c63, 0x69645f65, 0x74636572,
    0x00657669, 0x00040005, 0x00000004, 0x6e69616d, 0x00000000, 0x00050005, 0x0000000a, 0x756c6567,
    0x3b316628, 0x00000000, 0x00030005, 0x00000009, 0x00000078, 0x00030005, 0x00000022, 0x00646967,
    0x00080005, 0x00000025, 0x475f6c67, 0x61626f6c, 0x766e496c, 0x7461636f, 0x496e6f69, 0x00000044,
    0x00040005, 0x0000002b, 0x61726150, 0x0000736d, 0x00050006, 0x0000002b, 0x00000000, 0x6e756f63,
    0x00000074, 0x00040006, 0x0000002b, 0x00000001, 0x0000706f, 0x00030005, 0x0000002d, 0x00000000,
    0x00030005, 0x00000038, 0x00000076, 0x00030005, 0x0000003a, 0x00637253, 0x00040006, 0x0000003a,
    0x00000000, 0x00000061, 0x00030005, 0x0000003c, 0x00000000, 0x00040005, 0x00000053, 0x75736572,
    0x0000746c, 0x00040005, 0x0000006a, 0x61726170, 0x0000006d, 0x00030005, 0x00000080, 0x00747344,
    0x00040006, 0x00000080, 0x00000000, 0x00747364, 0x00030005, 0x00000082, 0x00000000, 0x00040047,
    0x00000025, 0x0000000b, 0x0000001c, 0x00050048, 0x0000002b, 0x00000000, 0x00000023, 0x00000000,
    0x00050048, 0x0000002b, 0x00000001, 0x00000023, 0x00000004, 0x00030047, 0x0000002b, 0x00000002,
    0x00040047, 0x00000039, 0x00000006, 0x00000004, 0x00050048, 0x0000003a, 0x00000000, 0x00000023,
    0x00000000, 0x00030047, 0x0000003a, 0x00000003, 0x00040047, 0x0000003c, 0x00000022, 0x00000000,
    0x00040047, 0x0000003c, 0x00000021, 0x00000001, 0x00040047, 0x0000007f, 0x00000006, 0x00000004,
    0x00050048, 0x00000080, 0x00000000, 0x00000023, 0x00000000, 0x00030047, 0x00000080, 0x00000003,
    0x00040047, 0x00000082, 0x00000022, 0x00000000, 0x00040047, 0x00000082, 0x00000021, 0x00000000,
    0x00040047, 0x00000088, 0x0000000b, 0x00000019, 0x00020013, 0x00000002, 0x00030021, 0x00000003,
    0x00000002, 0x00030016, 0x00000006, 0x00000020, 0x00040020, 0x00000007, 0x00000007, 0x00000006,
    0x00040021, 0x00000008, 0x00000006, 0x00000007, 0x0004002b, 0x00000006, 0x0000000c, 0x3f000000,
    0x0004002b, 0x00000006, 0x0000000f, 0x3f800000, 0x0004002b, 0x00000006, 0x00000010, 0x3f4c422a,
    0x0004002b, 0x00000006, 0x00000012, 0x3d372713, 0x00040015, 0x00000020, 0x00000020, 0x00000000,
    0x00040020, 0x00000021, 0x00000007, 0x00000020, 0x00040017, 0x00000023, 0x00000020, 0x00000003,
    0x00040020, 0x00000024, 0x00000001, 0x00000023, 0x0004003b, 0x00000024, 0x00000025, 0x00000001,
    0x0004002b, 0x00000020, 0x00000026, 0x00000000, 0x00040020, 0x00000027, 0x00000001, 0x00000020,
    0x0004001e, 0x0000002b, 0x00000020, 0x00000020, 0x00040020, 0x0000002c, 0x00000009, 0x0000002b,
    0x0004003b, 0x0000002c, 0x0000002d, 0x00000009, 0x00040015, 0x0000002e, 0x00000020, 0x00000001,
    0x0004002b, 0x0000002e, 0x0000002f, 0x00000000, 0x00040020, 0x00000030, 0x00000009, 0x00000020,
    0x00020014, 0x00000033, 0x0003001d, 0x00000039, 0x00000006, 0x0003001e, 0x0000003a, 0x00000039,
    0x00040020, 0x0000003b, 0x00000002, 0x0000003a, 0x0004003b, 0x0000003b, 0x0000003c, 0x00000002,
    0x00040020, 0x0000003e, 0x00000002, 0x00000006, 0x0004002b, 0x0000002e, 0x00000041, 0x00000001,
    0x0004002b, 0x00000006, 0x00000066, 0x00000000, 0x0003001d, 0x0000007f, 0x00000006, 0x0003001e,
    0x00000080, 0x0000007f, 0x00040020, 0x00000081, 0x00000002, 0x00000080, 0x0004003b, 0x00000081,
    0x00000082, 0x00000002, 0x0004002b, 0x00000020, 0x00000086, 0x00000100, 0x0004002b, 0x00000020,
    0x00000087, 0x00000001, 0x0006002c, 0x00000023, 0x00000088, 0x00000086, 0x00000087, 0x00000087,
    0x00050036, 0x00000002, 0x00000004, 0x00000000, 0x00000003, 0x000200f8, 0x00000005, 0x0004003b,
    0x00000021, 0x00000022, 0x00000007, 0x0004003b, 0x00000007, 0x00000038, 0x00000007, 0x0004003b,
    0x00000007, 0x00000053, 0x00000007, 0x0004003b, 0x00000007, 0x0000006a, 0x00000007, 0x00050041,
    0x00000027, 0x00000028, 0x00000025, 0x00000026, 0x0004003d, 0x00000020, 0x00000029, 0x00000028,
    0x0003003e, 0x00000022, 0x00000029, 0x0004003d, 0x00000020, 0x0000002a, 0x00000022, 0x00050041,
    0x00000030, 0x00000031, 0x0000002d, 0x0000002f, 0x0004003d, 0x00000020, 0x00000032, 0x00000031,
    0x000500ae, 0x00000033, 0x00000034, 0x0000002a, 0x00000032, 0x000300f7, 0x00000036, 0x00000000,
    0x000400fa, 0x00000034, 0x00000035, 0x00000036, 0x000200f8, 0x00000035, 0x000100fd, 0x000200f8,
    0x00000036, 0x0004003d, 0x00000020, 0x0000003d, 0x00000022, 0x00060041, 0x0000003e, 0x0000003f,
    0x0000003c, 0x0000002f, 0x0000003d, 0x0004003d, 0x00000006, 0x00000040, 0x0000003f, 0x0003003e,
    0x00000038, 0x00000040, 0x00050041, 0x00000030, 0x00000042, 0x0000002d, 0x00000041, 0x0004003d,
    0x00000020, 0x00000043, 0x00000042, 0x000300f7, 0x00000052, 0x00000000, 0x001d00fb, 0x00000043,
    0x00000051, 0x0000000a, 0x00000044, 0x0000000b, 0x00000045, 0x0000000c, 0x00000046, 0x0000000d,
    0x00000047, 0x0000000e, 0x00000048, 0x0000000f, 0x00000049, 0x00000010, 0x0000004a, 0x00000011,
    0x0000004b, 0x00000012, 0x0000004c, 0x00000013, 0x0000004d, 0x00000014, 0x0000004e, 0x00000015,
    0x0000004f, 0x00000016, 0x00000050, 0x000200f8, 0x00000051, 0x0003003e, 0x00000053, 0x00000066,
    0x000200f9, 0x00000052, 0x000200f8, 0x00000044, 0x0004003d, 0x00000006, 0x00000054, 0x00000038,
    0x0004007f, 0x00000006, 0x00000055, 0x00000054, 0x0003003e, 0x00000053, 0x00000055, 0x000200f9,
    0x00000052, 0x000200f8, 0x00000045, 0x0004003d, 0x00000006, 0x00000057, 0x00000038, 0x0006000c,
    0x00000006, 0x00000058, 0x00000001, 0x00000004, 0x00000057, 0x0003003e, 0x00000053, 0x00000058,
    0x000200f9, 0x00000052, 0x000200f8, 0x00000046, 0x0004003d, 0x00000006, 0x0000005a, 0x00000038,
    0x0006000c, 0x00000006, 0x0000005b, 0x00000001, 0x0000001f, 0x0000005a, 0x0003003e, 0x00000053,
    0x0000005b, 0x000200f9, 0x00000052, 0x000200f8, 0x00000047, 0x0004003d, 0x00000006, 0x0000005d,
    0x00000038, 0x0006000c, 0x00000006, 0x0000005e, 0x00000001, 0x0000001b, 0x0000005d, 0x0003003e,
    0x00000053, 0x0000005e, 0x000200f9, 0x00000052, 0x000200f8, 0x00000048, 0x0004003d, 0x00000006,
    0x00000060, 0x00000038, 0x0006000c, 0x00000006, 0x00000061, 0x00000001, 0x0000001c, 0x00000060,
    0x0003003e, 0x00000053, 0x00000061, 0x000200f9, 0x00000052, 0x000200f8, 0x00000049, 0x0004003d,
    0x00000006, 0x00000063, 0x00000038, 0x0006000c, 0x00000006, 0x00000064, 0x00000001, 0x00000015,
    0x00000063, 0x0003003e, 0x00000053, 0x00000064, 0x000200f9, 0x00000052, 0x000200f8, 0x0000004a,
    0x0004003d, 0x00000006, 0x00000067, 0x00000038, 0x0007000c, 0x00000006, 0x00000068, 0x00000001,
    0x00000028, 0x00000066, 0x00000067, 0x0003003e, 0x00000053, 0x00000068, 0x000200f9, 0x00000052,
    0x000200f8, 0x0000004b, 0x0004003d, 0x00000006, 0x0000006b, 0x00000038, 0x0003003e, 0x0000006a,
    0x0000006b, 0x00050039, 0x00000006, 0x0000006c, 0x0000000a, 0x0000006a, 0x0003003e, 0x00000053,
    0x0000006c, 0x000200f9, 0x00000052, 0x000200f8, 0x0000004c, 0x0004003d, 0x00000006, 0x0000006e,
    0x00000038, 0x0006000c, 0x00000006, 0x0000006f, 0x00000001, 0x0000000d, 0x0000006e, 0x0003003e,
    0x00000053, 0x0000006f, 0x000200f9, 0x00000052, 0x000200f8, 0x0000004d, 0x0004003d, 0x00000006,
    0x00000071, 0x00000038, 0x0006000c, 0x00000006, 0x00000072, 0x00000001, 0x0000000e, 0x00000071,
    0x0003003e, 0x00000053, 0x00000072, 0x000200f9, 0x00000052, 0x000200f8, 0x0000004e, 0x0004003d,
    0x00000006, 0x00000074, 0x00000038, 0x00050088, 0x00000006, 0x00000075, 0x0000000f, 0x00000074,
    0x0003003e, 0x00000053, 0x00000075, 0x000200f9, 0x00000052, 0x000200f8, 0x0000004f, 0x0004003d,
    0x00000006, 0x00000077, 0x00000038, 0x0004003d, 0x00000006, 0x00000078, 0x00000038, 0x00050085,
    0x00000006, 0x00000079, 0x00000077, 0x00000078, 0x0003003e, 0x00000053, 0x00000079, 0x000200f9,
    0x00000052, 0x000200f8, 0x00000050, 0x0004003d, 0x00000006, 0x0000007b, 0x00000038, 0x0003003e,
    0x00000053, 0x0000007b, 0x000200f9, 0x00000052, 0x000200f8, 0x00000052, 0x0004003d, 0x00000020,
    0x00000083, 0x00000022, 0x0004003d, 0x00000006, 0x00000084, 0x00000053, 0x00060041, 0x0000003e,
    0x00000085, 0x00000082, 0x0000002f, 0x00000083, 0x0003003e, 0x00000085, 0x00000084, 0x000100fd,
    0x00010038, 0x00050036, 0x00000006, 0x0000000a, 0x00000000, 0x00000008, 0x00030037, 0x00000007,
    0x00000009, 0x000200f8, 0x0000000b, 0x0004003d, 0x00000006, 0x0000000d, 0x00000009, 0x00050085,
    0x00000006, 0x0000000e, 0x0000000c, 0x0000000d, 0x0004003d, 0x00000006, 0x00000011, 0x00000009,
    0x0004003d, 0x00000006, 0x00000013, 0x00000009, 0x00050085, 0x00000006, 0x00000014, 0x00000012,
    0x00000013, 0x0004003d, 0x00000006, 0x00000015, 0x00000009, 0x00050085, 0x00000006, 0x00000016,
    0x00000014, 0x00000015, 0x0004003d, 0x00000006, 0x00000017, 0x00000009, 0x00050085, 0x00000006,
    0x00000018, 0x00000016, 0x00000017, 0x00050081, 0x00000006, 0x00000019, 0x00000011, 0x00000018,
    0x00050085, 0x00000006, 0x0000001a, 0x00000010, 0x00000019, 0x0006000c, 0x00000006, 0x0000001b,
    0x00000001, 0x00000015, 0x0000001a, 0x00050081, 0x00000006, 0x0000001c, 0x0000000f, 0x0000001b,
    0x00050085, 0x00000006, 0x0000001d, 0x0000000e, 0x0000001c, 0x000200fe, 0x0000001d, 0x00010038,
};

// reduce.spv - 4020 bytes
static const uint32_t shader_reduce[] = {
    0x07230203, 0x00010000, 0x000d000b, 0x000000a7, 0x00000000, 0x00020011, 0x00000001, 0x0006000b,
    0x00000001, 0x4c534c47, 0x6474732e, 0x3035342e, 0x00000000, 0x0003000e, 0x00000000, 0x00000001,
    0x0008000f, 0x00000005, 0x00000004, 0x6e69616d, 0x00000000, 0x0000000b, 0x00000011, 0x00000098,
    0x00060010, 0x00000004, 0x00000011, 0x00000100, 0x00000001, 0x00000001, 0x00030003, 0x00000002,
    0x000001c2, 0x000a0004, 0x475f4c47, 0x4c474f4f, 0x70635f45, 0x74735f70, 0x5f656c79, 0x656e696c,
    0x7269645f, 0x69746365, 0x00006576, 0x00080004, 0x475f4c47, 0x4c474f4f, 0x6e695f45, 0x64756c63,
    0x69645f65, 0x74636572, 0x00657669, 0x00040005, 0x00000004, 0x6e69616d, 0x00000000, 0x00030005,
    0x00000008, 0x00646974, 0x00080005, 0x0000000b, 0x4c5f6c67, 0x6c61636f, 0x6f766e49, 0x69746163,
    0x44496e6f, 0x00000000, 0x00030005, 0x00000010, 0x00646967, 0x00080005, 0x00000011, 0x475f6c67,
    0x61626f6c, 0x766e496c, 0x7461636f, 0x496e6f69, 0x00000044, 0x00040005, 0x00000015, 0x61726150,
    0x0000736d, 0x00050006, 0x00000015, 0x00000000, 0x6e756f63, 0x00000074, 0x00040006, 0x00000015,
    0x00000001, 0x0000706f, 0x00030005, 0x00000017, 0x00000000, 0x00040005, 0x00000025, 0x74616473,
    0x00000061, 0x00030005, 0x00000028, 0x00637253, 0x00040006, 0x00000028, 0x00000000, 0x00000061,
    0x00030005, 0x0000002a, 0x00000000, 0x00030005, 0x00000053, 0x00000073, 0x00060005, 0x00000098,
    0x575f6c67, 0x476b726f, 0x70756f72, 0x00004449, 0x00030005, 0x000000a0, 0x00747344, 0x00040006,
    0x000000a0, 0x00000000, 0x00747364, 0x00030005, 0x000000a2, 0x00000000, 0x00040047, 0x0000000b,
    0x0000000b, 0x0000001b, 0x00040047, 0x00000011, 0x0000000b, 0x0000001c, 0x00050048, 0x00000015,
    0x00000000, 0x00000023, 0x00000000, 0x00050048, 0x00000015, 0x00000001, 0x00000023, 0x00000004,
    0x00030047, 0x00000015, 0x00000002, 0x00040047, 0x00000027, 0x00000006, 0x00000004, 0x00050048,
    0x00000028, 0x00000000, 0x00000023, 0x00000000, 0x00030047, 0x00000028, 0x00000003, 0x00040047,
    0x0000002a, 0x00000022, 0x00000000, 0x00040047, 0x0000002a, 0x00000021, 0x00000001, 0x00040047,
    0x00000098, 0x0000000b, 0x0000001a, 0x00040047, 0x0000009f, 0x00000006, 0x00000004, 0x00050048,
    0x000000a0, 0x00000000, 0x00000023, 0x00000000, 0x00030047, 0x000000a0, 0x00000003, 0x00040047,
    0x000000a2, 0x00000022, 0x00000000, 0x00040047, 0x000000a2, 0x00000021, 0x00000000, 0x00040047,
    0x000000a6, 0x0000000b, 0x00000019, 0x00020013, 0x00000002, 0x00030021, 0x00000003, 0x00000002,
    0x00040015, 0x00000006, 0x00000020, 0x00000000, 0x00040020, 0x00000007, 0x00000007, 0x00000006,
    0x00040017, 0x00000009, 0x00000006, 0x00000003, 0x00040020, 0x0000000a, 0x00000001, 0x00000009,
    0x0004003b, 0x0000000a, 0x0000000b, 0x00000001, 0x0004002b, 0x00000006, 0x0000000c, 0x00000000,
    0x00040020, 0x0000000d, 0x00000001, 0x00000006, 0x0004003b, 0x0000000a, 0x00000011, 0x00000001,
    0x0004001e, 0x00000015, 0x00000006, 0x00000006, 0x00040020, 0x00000016, 0x00000009, 0x00000015,
    0x0004003b, 0x00000016, 0x00000017, 0x00000009, 0x00040015, 0x00000018, 0x00000020, 0x00000001,
    0x0004002b, 0x00000018, 0x00000019, 0x00000000, 0x00040020, 0x0000001a, 0x00000009, 0x00000006,
    0x00020014, 0x0000001d, 0x00030016, 0x00000021, 0x00000020, 0x0004002b, 0x00000006, 0x00000022,
    0x00000100, 0x0004001c, 0x00000023, 0x00000021, 0x00000022, 0x00040020, 0x00000024, 0x00000004,
    0x00000023, 0x0004003b, 0x00000024, 0x00000025, 0x00000004, 0x0003001d, 0x00000027, 0x00000021,
    0x0003001e, 0x00000028, 0x00000027, 0x00040020, 0x00000029, 0x00000002, 0x00000028, 0x0004003b,
    0x00000029, 0x0000002a, 0x00000002, 0x00040020, 0x0000002c, 0x00000002, 0x00000021, 0x00040020,
    0x0000002f, 0x00000004, 0x00000021, 0x0004002b, 0x00000018, 0x00000032, 0x00000001, 0x0004002b,
    0x00000021, 0x00000039, 0x00000000, 0x0004002b, 0x00000006, 0x0000003e, 0x00000001, 0x0004002b,
    0x00000021, 0x00000043, 0xfe967699, 0x0004002b, 0x00000006, 0x00000048, 0x00000002, 0x0004002b,
    0x00000021, 0x0000004d, 0x7e967699, 0x0004002b, 0x00000006, 0x00000052, 0x00000108, 0x0004002b,
    0x00000006, 0x00000054, 0x00000080, 0x0004003b, 0x0000000a, 0x00000098, 0x00000001, 0x0003001d,
    0x0000009f, 0x00000021, 0x0003001e, 0x000000a0, 0x0000009f, 0x00040020, 0x000000a1, 0x00000002,
    0x000000a0, 0x0004003b, 0x000000a1, 0x000000a2, 0x00000002, 0x0006002c, 0x00000009, 0x000000a6,
    0x00000022, 0x0000003e, 0x0000003e, 0x00050036, 0x00000002, 0x00000004, 0x00000000, 0x00000003,
    0x000200f8, 0x00000005, 0x0004003b, 0x00000007, 0x00000008, 0x00000007, 0x0004003b, 0x00000007,
    0x00000010, 0x00000007, 0x0004003b, 0x00000007, 0x00000053, 0x00000007, 0x00050041, 0x0000000d,
    0x0000000e, 0x0000000b, 0x0000000c, 0x0004003d, 0x00000006, 0x0000000f, 0x0000000e, 0x0003003e,
    0x00000008, 0x0000000f, 0x00050041, 0x0000000d, 0x00000012, 0x00000011, 0x0000000c, 0x0004003d,
    0x00000006, 0x00000013, 0x00000012, 0x0003003e, 0x00000010, 0x00000013, 0x0004003d, 0x00000006,
    0x00000014, 0x00000010, 0x00050041, 0x0000001a, 0x0000001b, 0x00000017, 0x00000019, 0x0004003d,
    0x00000006, 0x0000001c, 0x0000001b, 0x000500b0, 0x0000001d, 0x0000001e, 0x00000014, 0x0000001c,
    0x000300f7, 0x00000020, 0x00000000, 0x000400fa, 0x0000001e, 0x0000001f, 0x00000031, 0x000200f8,
    0x0000001f, 0x0004003d, 0x00000006, 0x00000026, 0x00000008, 0x0004003d, 0x00000006, 0x0000002b,
    0x00000010, 0x00060041, 0x0000002c, 0x0000002d, 0x0000002a, 0x00000019, 0x0000002b, 0x0004003d,
    0x00000021, 0x0000002e, 0x0000002d, 0x00050041, 0x0000002f, 0x00000030, 0x00000025, 0x00000026,
    0x0003003e, 0x00000030, 0x0000002e, 0x000200f9, 0x00000020, 0x000200f8, 0x00000031, 0x00050041,
    0x0000001a, 0x00000033, 0x00000017, 0x00000032, 0x0004003d, 0x00000006, 0x00000034, 0x00000033,
    0x000500aa, 0x0000001d, 0x00000035, 0x00000034, 0x0000000c, 0x000300f7, 0x00000037, 0x00000000,
    0x000400fa, 0x00000035, 0x00000036, 0x0000003b, 0x000200f8, 0x00000036, 0x0004003d, 0x00000006,
    0x00000038, 0x00000008, 0x00050041, 0x0000002f, 0x0000003a, 0x00000025, 0x00000038, 0x0003003e,
    0x0000003a, 0x00000039, 0x000200f9, 0x00000037, 0x000200f8, 0x0000003b, 0x00050041, 0x0000001a,
    0x0000003c, 0x00000017, 0x00000032, 0x0004003d, 0x00000006, 0x0000003d, 0x0000003c, 0x000500aa,
    0x0000001d, 0x0000003f, 0x0000003d, 0x0000003e, 0x000300f7, 0x00000041, 0x00000000, 0x000400fa,
    0x0000003f, 0x00000040, 0x00000045, 0x000200f8, 0x00000040, 0x0004003d, 0x00000006, 0x00000042,
    0x00000008, 0x00050041, 0x0000002f, 0x00000044, 0x00000025, 0x00000042, 0x0003003e, 0x00000044,
    0x00000043, 0x000200f9, 0x00000041, 0x000200f8, 0x00000045, 0x00050041, 0x0000001a, 0x00000046,
    0x00000017, 0x00000032, 0x0004003d, 0x00000006, 0x00000047, 0x00000046, 0x000500aa, 0x0000001d,
    0x00000049, 0x00000047, 0x00000048, 0x000300f7, 0x0000004b, 0x00000000, 0x000400fa, 0x00000049,
    0x0000004a, 0x0000004f, 0x000200f8, 0x0000004a, 0x0004003d, 0x00000006, 0x0000004c, 0x00000008,
    0x00050041, 0x0000002f, 0x0000004e, 0x00000025, 0x0000004c, 0x0003003e, 0x0000004e, 0x0000004d,
    0x000200f9, 0x0000004b, 0x000200f8, 0x0000004f, 0x0004003d, 0x00000006, 0x00000050, 0x00000008,
    0x00050041, 0x0000002f, 0x00000051, 0x00000025, 0x00000050, 0x0003003e, 0x00000051, 0x00000039,
    0x000200f9, 0x0000004b, 0x000200f8, 0x0000004b, 0x000200f9, 0x00000041, 0x000200f8, 0x00000041,
    0x000200f9, 0x00000037, 0x000200f8, 0x00000037, 0x000200f9, 0x00000020, 0x000200f8, 0x00000020,
    0x000400e0, 0x00000048, 0x00000048, 0x00000052, 0x0003003e, 0x00000053, 0x00000054, 0x000200f9,
    0x00000055, 0x000200f8, 0x00000055, 0x000400f6, 0x00000057, 0x00000058, 0x00000000, 0x000200f9,
    0x00000059, 0x000200f8, 0x00000059, 0x0004003d, 0x00000006, 0x0000005a, 0x00000053, 0x000500ac,
    0x0000001d, 0x0000005b, 0x0000005a, 0x0000000c, 0x000400fa, 0x0000005b, 0x00000056, 0x00000057,
    0x000200f8, 0x00000056, 0x0004003d, 0x00000006, 0x0000005c, 0x00000008, 0x0004003d, 0x00000006,
    0x0000005d, 0x00000053, 0x000500b0, 0x0000001d, 0x0000005e, 0x0000005c, 0x0000005d, 0x000300f7,
    0x00000060, 0x00000000, 0x000400fa, 0x0000005e, 0x0000005f, 0x00000060, 0x000200f8, 0x0000005f,
    0x00050041, 0x0000001a, 0x00000061, 0x00000017, 0x00000032, 0x0004003d, 0x00000006, 0x00000062,
    0x00000061, 0x000500aa, 0x0000001d, 0x00000063, 0x00000062, 0x0000000c, 0x000300f7, 0x00000065,
    0x00000000, 0x000400fa, 0x00000063, 0x00000064, 0x00000070, 0x000200f8, 0x00000064, 0x0004003d,
    0x00000006, 0x00000066, 0x00000008, 0x0004003d, 0x00000006, 0x00000067, 0x00000008, 0x0004003d,
    0x00000006, 0x00000068, 0x00000053, 0x00050080, 0x00000006, 0x00000069, 0x00000067, 0x00000068,
    0x00050041, 0x0000002f, 0x0000006a, 0x00000025, 0x00000069, 0x0004003d, 0x00000021, 0x0000006b,
    0x0000006a, 0x00050041, 0x0000002f, 0x0000006c, 0x00000025, 0x00000066, 0x0004003d, 0x00000021,
    0x0000006d, 0x0000006c, 0x00050081, 0x00000021, 0x0000006e, 0x0000006d, 0x0000006b, 0x00050041,
    0x0000002f, 0x0000006f, 0x00000025, 0x00000066, 0x0003003e, 0x0000006f, 0x0000006e, 0x000200f9,
    0x00000065, 0x000200f8, 0x00000070, 0x00050041, 0x0000001a, 0x00000071, 0x00000017, 0x00000032,
    0x0004003d, 0x00000006, 0x00000072, 0x00000071, 0x000500aa, 0x0000001d, 0x00000073, 0x00000072,
    0x0000003e, 0x000300f7, 0x00000075, 0x00000000, 0x000400fa, 0x00000073, 0x00000074, 0x00000081,
    0x000200f8, 0x00000074, 0x0004003d, 0x00000006, 0x00000076, 0x00000008, 0x0004003d, 0x00000006,
    0x00000077, 0x00000008, 0x00050041, 0x0000002f, 0x00000078, 0x00000025, 0x00000077, 0x0004003d,
    0x00000021, 0x00000079, 0x00000078, 0x0004003d, 0x00000006, 0x0000007a, 0x00000008, 0x0004003d,
    0x00000006, 0x0000007b, 0x00000053, 0x00050080, 0x00000006, 0x0000007c, 0x0000007a, 0x0000007b,
    0x00050041, 0x0000002f, 0x0000007d, 0x00000025, 0x0000007c, 0x0004003d, 0x00000021, 0x0000007e,
    0x0000007d, 0x0007000c, 0x00000021, 0x0000007f, 0x00000001, 0x00000028, 0x00000079, 0x0000007e,
    0x00050041, 0x0000002f, 0x00000080, 0x00000025, 0x00000076, 0x0003003e, 0x00000080, 0x0000007f,
    0x000200f9, 0x00000075, 0x000200f8, 0x00000081, 0x00050041, 0x0000001a, 0x00000082, 0x00000017,
    0x00000032, 0x0004003d, 0x00000006, 0x00000083, 0x00000082, 0x000500aa, 0x0000001d, 0x00000084,
    0x00000083, 0x00000048, 0x000300f7, 0x00000086, 0x00000000, 0x000400fa, 0x00000084, 0x00000085,
    0x00000086, 0x000200f8, 0x00000085, 0x0004003d, 0x00000006, 0x00000087, 0x00000008, 0x0004003d,
    0x00000006, 0x00000088, 0x00000008, 0x00050041, 0x0000002f, 0x00000089, 0x00000025, 0x00000088,
    0x0004003d, 0x00000021, 0x0000008a, 0x00000089, 0x0004003d, 0x00000006, 0x0000008b, 0x00000008,
    0x0004003d, 0x00000006, 0x0000008c, 0x00000053, 0x00050080, 0x00000006, 0x0000008d, 0x0000008b,
    0x0000008c, 0x00050041, 0x0000002f, 0x0000008e, 0x00000025, 0x0000008d, 0x0004003d, 0x00000021,
    0x0000008f, 0x0000008e, 0x0007000c, 0x00000021, 0x00000090, 0x00000001, 0x00000025, 0x0000008a,
    0x0000008f, 0x00050041, 0x0000002f, 0x00000091, 0x00000025, 0x00000087, 0x0003003e, 0x00000091,
    0x00000090, 0x000200f9, 0x00000086, 0x000200f8, 0x00000086, 0x000200f9, 0x00000075, 0x000200f8,
    0x00000075, 0x000200f9, 0x00000065, 0x000200f8, 0x00000065, 0x000200f9, 0x00000060, 0x000200f8,
    0x00000060, 0x000400e0, 0x00000048, 0x00000048, 0x00000052, 0x000200f9, 0x00000058, 0x000200f8,
    0x00000058, 0x0004003d, 0x00000006, 0x00000092, 0x00000053, 0x000500c2, 0x00000006, 0x00000093,
    0x00000092, 0x0000003e, 0x0003003e, 0x00000053, 0x00000093, 0x000200f9, 0x00000055, 0x000200f8,
    0x00000057, 0x0004003d, 0x00000006, 0x00000094, 0x00000008, 0x000500aa, 0x0000001d, 0x00000095,
    0x00000094, 0x0000000c, 0x000300f7, 0x00000097, 0x00000000, 0x000400fa, 0x00000095, 0x00000096,
    0x00000097, 0x000200f8, 0x00000096, 0x00050041, 0x0000000d, 0x00000099, 0x00000098, 0x0000000c,
    0x0004003d, 0x00000006, 0x0000009a, 0x00000099, 0x000500aa, 0x0000001d, 0x0000009b, 0x0000009a,
    0x0000000c, 0x000200f9, 0x00000097, 0x000200f8, 0x00000097, 0x000700f5, 0x0000001d, 0x0000009c,
    0x00000095, 0x00000057, 0x0000009b, 0x00000096, 0x000300f7, 0x0000009e, 0x00000000, 0x000400fa,
    0x0000009c, 0x0000009d, 0x0000009e, 0x000200f8, 0x0000009d, 0x00050041, 0x0000002f, 0x000000a3,
    0x00000025, 0x00000019, 0x0004003d, 0x00000021, 0x000000a4, 0x000000a3, 0x00060041, 0x0000002c,
    0x000000a5, 0x000000a2, 0x00000019, 0x00000019, 0x0003003e, 0x000000a5, 0x000000a4, 0x000200f9,
    0x0000009e, 0x000200f8, 0x0000009e, 0x000100fd, 0x00010038,
};

// ============================================
// Internal Types
// ============================================

typedef struct {
    VkBuffer buf;
    VkDeviceMemory mem;
    void* ptr;
} adamah_Buffer;

typedef struct {
    int active;
    uint32_t word_size;
    uint32_t pack_size;
    uint32_t n_packs;
    uint64_t total_elems;
    uint64_t total_bytes;
    adamah_Buffer data;
    adamah_Buffer gpu_locs;
    adamah_Buffer gpu_vals;
    VkDescriptorSet desc_scatter;
    VkDescriptorSet desc_gather;
    VkCommandBuffer cmd;
    VkFence fence;
} adamah_Map;

typedef struct {
    VkBuffer buf;
    VkDeviceMemory mem;
    void* ptr;
    uint32_t size;
} adamah_VBuf;

typedef struct {
    VkPipeline scatter;
    VkPipeline gather;
    int created;
} adamah_Pipeline;

static struct {
    int initialized;
    VkInstance instance;
    VkPhysicalDevice phys;
    VkDevice device;
    VkQueue queue;
    uint32_t queue_family;
    VkShaderModule scatter_shader;
    VkShaderModule gather_shader;
    VkShaderModule binary_shader;
    VkShaderModule unary_shader;
    VkShaderModule reduce_shader;
    VkDescriptorSetLayout desc_layout;
    VkDescriptorSetLayout desc_layout_math;
    VkPipelineLayout pipe_layout;
    VkPipelineLayout pipe_layout_math;
    VkDescriptorPool desc_pool;
    VkCommandPool cmd_pool;
    VkCommandBuffer cmd;
    VkFence fence;
    adamah_Pipeline pipelines[8];
    VkPipeline pipe_binary;
    VkPipeline pipe_unary;
    VkPipeline pipe_reduce;
    adamah_Map maps[ADAMAH_MAX_MAPS];
    adamah_VBuf vbufs[ADAMAH_MAX_VBUFS];
} g_ctx = {0};

// ============================================
// Helpers
// ============================================

static int is_power_of_two(uint32_t v) { return v && ((v & (v - 1)) == 0); }
static int is_valid_word_size(uint32_t ws) { return ws == 4 || ws == 8 || ws == 16 || ws == 32; }

static uint32_t find_memory_type(uint32_t type_bits, VkMemoryPropertyFlags props) {
    VkPhysicalDeviceMemoryProperties mem_props;
    vkGetPhysicalDeviceMemoryProperties(g_ctx.phys, &mem_props);
    for (uint32_t i = 0; i < mem_props.memoryTypeCount; i++) {
        if ((type_bits & (1u << i)) && (mem_props.memoryTypes[i].propertyFlags & props) == props)
            return i;
    }
    return UINT32_MAX;
}

static int create_buffer(VkDeviceSize size, VkBufferUsageFlags usage, 
                         VkMemoryPropertyFlags props, adamah_Buffer* out) {
    memset(out, 0, sizeof(*out));
    VkBufferCreateInfo bci = { .sType = VK_STRUCTURE_TYPE_BUFFER_CREATE_INFO, .size = size, .usage = usage };
    if (vkCreateBuffer(g_ctx.device, &bci, NULL, &out->buf) != VK_SUCCESS) return ADAMAH_ERR_VULKAN;
    
    VkMemoryRequirements reqs;
    vkGetBufferMemoryRequirements(g_ctx.device, out->buf, &reqs);
    uint32_t mtype = find_memory_type(reqs.memoryTypeBits, props);
    if (mtype == UINT32_MAX) { vkDestroyBuffer(g_ctx.device, out->buf, NULL); return ADAMAH_ERR_MEMORY; }
    
    VkMemoryAllocateInfo mai = { .sType = VK_STRUCTURE_TYPE_MEMORY_ALLOCATE_INFO, .allocationSize = reqs.size, .memoryTypeIndex = mtype };
    if (vkAllocateMemory(g_ctx.device, &mai, NULL, &out->mem) != VK_SUCCESS) {
        vkDestroyBuffer(g_ctx.device, out->buf, NULL); return ADAMAH_ERR_MEMORY;
    }
    vkBindBufferMemory(g_ctx.device, out->buf, out->mem, 0);
    if (props & VK_MEMORY_PROPERTY_HOST_VISIBLE_BIT) vkMapMemory(g_ctx.device, out->mem, 0, size, 0, &out->ptr);
    return ADAMAH_OK;
}

static void destroy_buffer(adamah_Buffer* b) {
    if (b->ptr) vkUnmapMemory(g_ctx.device, b->mem);
    if (b->buf) vkDestroyBuffer(g_ctx.device, b->buf, NULL);
    if (b->mem) vkFreeMemory(g_ctx.device, b->mem, NULL);
    memset(b, 0, sizeof(*b));
}

static int create_shader_module(const uint32_t* code, size_t size, VkShaderModule* out) {
    VkShaderModuleCreateInfo ci = { .sType = VK_STRUCTURE_TYPE_SHADER_MODULE_CREATE_INFO, .codeSize = size, .pCode = code };
    return (vkCreateShaderModule(g_ctx.device, &ci, NULL, out) == VK_SUCCESS) ? ADAMAH_OK : ADAMAH_ERR_VULKAN;
}

static int create_pipeline_variant(uint32_t words_per_elem) {
    uint32_t idx = words_per_elem - 1;
    if (idx >= 8 || g_ctx.pipelines[idx].created) return ADAMAH_OK;
    
    VkSpecializationMapEntry spec_entry = { .constantID = 0, .offset = 0, .size = sizeof(uint32_t) };
    VkSpecializationInfo spec_info = { .mapEntryCount = 1, .pMapEntries = &spec_entry, .dataSize = sizeof(uint32_t), .pData = &words_per_elem };
    
    VkPipelineShaderStageCreateInfo stage = { .sType = VK_STRUCTURE_TYPE_PIPELINE_SHADER_STAGE_CREATE_INFO,
        .stage = VK_SHADER_STAGE_COMPUTE_BIT, .module = g_ctx.scatter_shader, .pName = "main", .pSpecializationInfo = &spec_info };
    VkComputePipelineCreateInfo cpci = { .sType = VK_STRUCTURE_TYPE_COMPUTE_PIPELINE_CREATE_INFO, .stage = stage, .layout = g_ctx.pipe_layout };
    if (vkCreateComputePipelines(g_ctx.device, VK_NULL_HANDLE, 1, &cpci, NULL, &g_ctx.pipelines[idx].scatter) != VK_SUCCESS) return ADAMAH_ERR_VULKAN;
    
    cpci.stage.module = g_ctx.gather_shader;
    if (vkCreateComputePipelines(g_ctx.device, VK_NULL_HANDLE, 1, &cpci, NULL, &g_ctx.pipelines[idx].gather) != VK_SUCCESS) return ADAMAH_ERR_VULKAN;
    
    g_ctx.pipelines[idx].created = 1;
    return ADAMAH_OK;
}

// ============================================
// Init / Shutdown
// ============================================

int adamah_init(void) {
    if (g_ctx.initialized) return ADAMAH_OK;
    
    VkApplicationInfo ai = { .sType = VK_STRUCTURE_TYPE_APPLICATION_INFO, .pApplicationName = "ADAMAH", .apiVersion = VK_API_VERSION_1_0 };
    VkInstanceCreateInfo ici = { .sType = VK_STRUCTURE_TYPE_INSTANCE_CREATE_INFO, .pApplicationInfo = &ai };
    if (vkCreateInstance(&ici, NULL, &g_ctx.instance) != VK_SUCCESS) return ADAMAH_ERR_VULKAN;
    
    uint32_t count = 0;
    vkEnumeratePhysicalDevices(g_ctx.instance, &count, NULL);
    if (count == 0) { vkDestroyInstance(g_ctx.instance, NULL); return ADAMAH_ERR_VULKAN; }
    VkPhysicalDevice* devs = malloc(count * sizeof(VkPhysicalDevice));
    vkEnumeratePhysicalDevices(g_ctx.instance, &count, devs);
    g_ctx.phys = devs[0];
    free(devs);
    
    uint32_t qcount = 0;
    vkGetPhysicalDeviceQueueFamilyProperties(g_ctx.phys, &qcount, NULL);
    VkQueueFamilyProperties* qprops = malloc(qcount * sizeof(VkQueueFamilyProperties));
    vkGetPhysicalDeviceQueueFamilyProperties(g_ctx.phys, &qcount, qprops);
    g_ctx.queue_family = UINT32_MAX;
    for (uint32_t i = 0; i < qcount; i++) { if (qprops[i].queueFlags & VK_QUEUE_COMPUTE_BIT) { g_ctx.queue_family = i; break; } }
    free(qprops);
    if (g_ctx.queue_family == UINT32_MAX) { vkDestroyInstance(g_ctx.instance, NULL); return ADAMAH_ERR_VULKAN; }
    
    float priority = 1.0f;
    VkDeviceQueueCreateInfo qci = { .sType = VK_STRUCTURE_TYPE_DEVICE_QUEUE_CREATE_INFO, .queueFamilyIndex = g_ctx.queue_family, .queueCount = 1, .pQueuePriorities = &priority };
    VkDeviceCreateInfo dci = { .sType = VK_STRUCTURE_TYPE_DEVICE_CREATE_INFO, .queueCreateInfoCount = 1, .pQueueCreateInfos = &qci };
    if (vkCreateDevice(g_ctx.phys, &dci, NULL, &g_ctx.device) != VK_SUCCESS) { vkDestroyInstance(g_ctx.instance, NULL); return ADAMAH_ERR_VULKAN; }
    vkGetDeviceQueue(g_ctx.device, g_ctx.queue_family, 0, &g_ctx.queue);
    
    // Shaders
    create_shader_module(shader_scatter, sizeof(shader_scatter), &g_ctx.scatter_shader);
    create_shader_module(shader_gather, sizeof(shader_gather), &g_ctx.gather_shader);
    create_shader_module(shader_binary, sizeof(shader_binary), &g_ctx.binary_shader);
    create_shader_module(shader_unary, sizeof(shader_unary), &g_ctx.unary_shader);
    create_shader_module(shader_reduce, sizeof(shader_reduce), &g_ctx.reduce_shader);
    
    // Descriptor layout for scatter/gather (3 buffers)
    VkDescriptorSetLayoutBinding bindings[3] = {
        {0, VK_DESCRIPTOR_TYPE_STORAGE_BUFFER, 1, VK_SHADER_STAGE_COMPUTE_BIT, NULL},
        {1, VK_DESCRIPTOR_TYPE_STORAGE_BUFFER, 1, VK_SHADER_STAGE_COMPUTE_BIT, NULL},
        {2, VK_DESCRIPTOR_TYPE_STORAGE_BUFFER, 1, VK_SHADER_STAGE_COMPUTE_BIT, NULL},
    };
    VkDescriptorSetLayoutCreateInfo dslci = { .sType = VK_STRUCTURE_TYPE_DESCRIPTOR_SET_LAYOUT_CREATE_INFO, .bindingCount = 3, .pBindings = bindings };
    vkCreateDescriptorSetLayout(g_ctx.device, &dslci, NULL, &g_ctx.desc_layout);
    vkCreateDescriptorSetLayout(g_ctx.device, &dslci, NULL, &g_ctx.desc_layout_math);
    
    // Push constants
    VkPushConstantRange pcr = { .stageFlags = VK_SHADER_STAGE_COMPUTE_BIT, .offset = 0, .size = sizeof(uint32_t) };
    VkPipelineLayoutCreateInfo plci = { .sType = VK_STRUCTURE_TYPE_PIPELINE_LAYOUT_CREATE_INFO, .setLayoutCount = 1, .pSetLayouts = &g_ctx.desc_layout, .pushConstantRangeCount = 1, .pPushConstantRanges = &pcr };
    vkCreatePipelineLayout(g_ctx.device, &plci, NULL, &g_ctx.pipe_layout);
    
    VkPushConstantRange pcr_math = { .stageFlags = VK_SHADER_STAGE_COMPUTE_BIT, .offset = 0, .size = sizeof(uint32_t) * 2 };
    plci.pSetLayouts = &g_ctx.desc_layout_math;
    plci.pPushConstantRanges = &pcr_math;
    vkCreatePipelineLayout(g_ctx.device, &plci, NULL, &g_ctx.pipe_layout_math);
    
    // Descriptor pool
    VkDescriptorPoolSize dps = { .type = VK_DESCRIPTOR_TYPE_STORAGE_BUFFER, .descriptorCount = 1024 };
    VkDescriptorPoolCreateInfo dpci = { .sType = VK_STRUCTURE_TYPE_DESCRIPTOR_POOL_CREATE_INFO, .maxSets = 256, .poolSizeCount = 1, .pPoolSizes = &dps };
    vkCreateDescriptorPool(g_ctx.device, &dpci, NULL, &g_ctx.desc_pool);
    
    // Command pool
    VkCommandPoolCreateInfo cpci = { .sType = VK_STRUCTURE_TYPE_COMMAND_POOL_CREATE_INFO, .flags = VK_COMMAND_POOL_CREATE_RESET_COMMAND_BUFFER_BIT, .queueFamilyIndex = g_ctx.queue_family };
    vkCreateCommandPool(g_ctx.device, &cpci, NULL, &g_ctx.cmd_pool);
    
    // Command buffer and fence for math ops
    VkCommandBufferAllocateInfo cbai = { .sType = VK_STRUCTURE_TYPE_COMMAND_BUFFER_ALLOCATE_INFO, .commandPool = g_ctx.cmd_pool, .level = VK_COMMAND_BUFFER_LEVEL_PRIMARY, .commandBufferCount = 1 };
    vkAllocateCommandBuffers(g_ctx.device, &cbai, &g_ctx.cmd);
    VkFenceCreateInfo fci = { .sType = VK_STRUCTURE_TYPE_FENCE_CREATE_INFO, .flags = VK_FENCE_CREATE_SIGNALED_BIT };
    vkCreateFence(g_ctx.device, &fci, NULL, &g_ctx.fence);
    
    // Math pipelines
    VkPipelineShaderStageCreateInfo stage = { .sType = VK_STRUCTURE_TYPE_PIPELINE_SHADER_STAGE_CREATE_INFO, .stage = VK_SHADER_STAGE_COMPUTE_BIT, .pName = "main" };
    VkComputePipelineCreateInfo cpci2 = { .sType = VK_STRUCTURE_TYPE_COMPUTE_PIPELINE_CREATE_INFO, .layout = g_ctx.pipe_layout_math };
    
    stage.module = g_ctx.binary_shader; cpci2.stage = stage;
    vkCreateComputePipelines(g_ctx.device, VK_NULL_HANDLE, 1, &cpci2, NULL, &g_ctx.pipe_binary);
    stage.module = g_ctx.unary_shader; cpci2.stage = stage;
    vkCreateComputePipelines(g_ctx.device, VK_NULL_HANDLE, 1, &cpci2, NULL, &g_ctx.pipe_unary);
    stage.module = g_ctx.reduce_shader; cpci2.stage = stage;
    vkCreateComputePipelines(g_ctx.device, VK_NULL_HANDLE, 1, &cpci2, NULL, &g_ctx.pipe_reduce);
    
    g_ctx.initialized = 1;
    return ADAMAH_OK;
}

void adamah_shutdown(void) {
    if (!g_ctx.initialized) return;
    vkDeviceWaitIdle(g_ctx.device);
    
    for (int i = 0; i < ADAMAH_MAX_MAPS; i++) if (g_ctx.maps[i].active) map_destroy(i);
    for (int i = 0; i < ADAMAH_MAX_VBUFS; i++) if (g_ctx.vbufs[i].buf) vbuf_free(i);
    for (int i = 0; i < 8; i++) {
        if (g_ctx.pipelines[i].created) {
            vkDestroyPipeline(g_ctx.device, g_ctx.pipelines[i].scatter, NULL);
            vkDestroyPipeline(g_ctx.device, g_ctx.pipelines[i].gather, NULL);
        }
    }
    if (g_ctx.pipe_binary) vkDestroyPipeline(g_ctx.device, g_ctx.pipe_binary, NULL);
    if (g_ctx.pipe_unary) vkDestroyPipeline(g_ctx.device, g_ctx.pipe_unary, NULL);
    if (g_ctx.pipe_reduce) vkDestroyPipeline(g_ctx.device, g_ctx.pipe_reduce, NULL);
    if (g_ctx.fence) vkDestroyFence(g_ctx.device, g_ctx.fence, NULL);
    if (g_ctx.cmd_pool) vkDestroyCommandPool(g_ctx.device, g_ctx.cmd_pool, NULL);
    if (g_ctx.desc_pool) vkDestroyDescriptorPool(g_ctx.device, g_ctx.desc_pool, NULL);
    if (g_ctx.pipe_layout) vkDestroyPipelineLayout(g_ctx.device, g_ctx.pipe_layout, NULL);
    if (g_ctx.pipe_layout_math) vkDestroyPipelineLayout(g_ctx.device, g_ctx.pipe_layout_math, NULL);
    if (g_ctx.desc_layout) vkDestroyDescriptorSetLayout(g_ctx.device, g_ctx.desc_layout, NULL);
    if (g_ctx.desc_layout_math) vkDestroyDescriptorSetLayout(g_ctx.device, g_ctx.desc_layout_math, NULL);
    if (g_ctx.scatter_shader) vkDestroyShaderModule(g_ctx.device, g_ctx.scatter_shader, NULL);
    if (g_ctx.gather_shader) vkDestroyShaderModule(g_ctx.device, g_ctx.gather_shader, NULL);
    if (g_ctx.binary_shader) vkDestroyShaderModule(g_ctx.device, g_ctx.binary_shader, NULL);
    if (g_ctx.unary_shader) vkDestroyShaderModule(g_ctx.device, g_ctx.unary_shader, NULL);
    if (g_ctx.reduce_shader) vkDestroyShaderModule(g_ctx.device, g_ctx.reduce_shader, NULL);
    if (g_ctx.device) vkDestroyDevice(g_ctx.device, NULL);
    if (g_ctx.instance) vkDestroyInstance(g_ctx.instance, NULL);
    memset(&g_ctx, 0, sizeof(g_ctx));
}

// ============================================
// Memory Maps
// ============================================

int map_init(uint32_t id, uint32_t word_size, uint32_t pack_size, uint32_t n_packs) {
    if (!g_ctx.initialized || id >= ADAMAH_MAX_MAPS) return ADAMAH_ERR_INVALID;
    if (g_ctx.maps[id].active) return ADAMAH_ERR_EXISTS;
    if (!is_valid_word_size(word_size) || !is_power_of_two(pack_size) || !pack_size || !n_packs) return ADAMAH_ERR_INVALID;
    
    uint32_t wpe = word_size / 4;
    int ret = create_pipeline_variant(wpe);
    if (ret != ADAMAH_OK) return ret;
    
    adamah_Map* m = &g_ctx.maps[id];
    memset(m, 0, sizeof(*m));
    m->word_size = word_size;
    m->pack_size = pack_size;
    m->n_packs = n_packs;
    m->total_elems = (uint64_t)pack_size * n_packs;
    m->total_bytes = m->total_elems * word_size;
    
    VkMemoryPropertyFlags host_props = VK_MEMORY_PROPERTY_HOST_VISIBLE_BIT | VK_MEMORY_PROPERTY_HOST_COHERENT_BIT;
    ret = create_buffer(m->total_bytes, VK_BUFFER_USAGE_STORAGE_BUFFER_BIT | VK_BUFFER_USAGE_TRANSFER_DST_BIT, host_props, &m->data);
    if (ret != ADAMAH_OK) return ret;
    memset(m->data.ptr, 0, m->total_bytes);
    
    ret = create_buffer(pack_size * sizeof(uint64_t), VK_BUFFER_USAGE_STORAGE_BUFFER_BIT, host_props, &m->gpu_locs);
    if (ret != ADAMAH_OK) { destroy_buffer(&m->data); return ret; }
    
    ret = create_buffer(pack_size * word_size, VK_BUFFER_USAGE_STORAGE_BUFFER_BIT, host_props, &m->gpu_vals);
    if (ret != ADAMAH_OK) { destroy_buffer(&m->data); destroy_buffer(&m->gpu_locs); return ret; }
    
    // Descriptor sets
    VkDescriptorSetAllocateInfo dsai = { .sType = VK_STRUCTURE_TYPE_DESCRIPTOR_SET_ALLOCATE_INFO, .descriptorPool = g_ctx.desc_pool, .descriptorSetCount = 1, .pSetLayouts = &g_ctx.desc_layout };
    vkAllocateDescriptorSets(g_ctx.device, &dsai, &m->desc_scatter);
    vkAllocateDescriptorSets(g_ctx.device, &dsai, &m->desc_gather);
    
    VkDescriptorBufferInfo locs_info = { m->gpu_locs.buf, 0, VK_WHOLE_SIZE };
    VkDescriptorBufferInfo vals_info = { m->gpu_vals.buf, 0, VK_WHOLE_SIZE };
    VkDescriptorBufferInfo data_info = { m->data.buf, 0, VK_WHOLE_SIZE };
    
    VkWriteDescriptorSet writes_scatter[3] = {
        { .sType = VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET, .dstSet = m->desc_scatter, .dstBinding = 0, .descriptorCount = 1, .descriptorType = VK_DESCRIPTOR_TYPE_STORAGE_BUFFER, .pBufferInfo = &locs_info },
        { .sType = VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET, .dstSet = m->desc_scatter, .dstBinding = 1, .descriptorCount = 1, .descriptorType = VK_DESCRIPTOR_TYPE_STORAGE_BUFFER, .pBufferInfo = &vals_info },
        { .sType = VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET, .dstSet = m->desc_scatter, .dstBinding = 2, .descriptorCount = 1, .descriptorType = VK_DESCRIPTOR_TYPE_STORAGE_BUFFER, .pBufferInfo = &data_info },
    };
    vkUpdateDescriptorSets(g_ctx.device, 3, writes_scatter, 0, NULL);
    
    VkWriteDescriptorSet writes_gather[3] = {
        { .sType = VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET, .dstSet = m->desc_gather, .dstBinding = 0, .descriptorCount = 1, .descriptorType = VK_DESCRIPTOR_TYPE_STORAGE_BUFFER, .pBufferInfo = &locs_info },
        { .sType = VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET, .dstSet = m->desc_gather, .dstBinding = 1, .descriptorCount = 1, .descriptorType = VK_DESCRIPTOR_TYPE_STORAGE_BUFFER, .pBufferInfo = &data_info },
        { .sType = VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET, .dstSet = m->desc_gather, .dstBinding = 2, .descriptorCount = 1, .descriptorType = VK_DESCRIPTOR_TYPE_STORAGE_BUFFER, .pBufferInfo = &vals_info },
    };
    vkUpdateDescriptorSets(g_ctx.device, 3, writes_gather, 0, NULL);
    
    // Command buffer and fence
    VkCommandBufferAllocateInfo cbai = { .sType = VK_STRUCTURE_TYPE_COMMAND_BUFFER_ALLOCATE_INFO, .commandPool = g_ctx.cmd_pool, .level = VK_COMMAND_BUFFER_LEVEL_PRIMARY, .commandBufferCount = 1 };
    vkAllocateCommandBuffers(g_ctx.device, &cbai, &m->cmd);
    VkFenceCreateInfo fci = { .sType = VK_STRUCTURE_TYPE_FENCE_CREATE_INFO, .flags = VK_FENCE_CREATE_SIGNALED_BIT };
    vkCreateFence(g_ctx.device, &fci, NULL, &m->fence);
    
    m->active = 1;
    return ADAMAH_OK;
}

int map_destroy(uint32_t id) {
    if (!g_ctx.initialized || id >= ADAMAH_MAX_MAPS || !g_ctx.maps[id].active) return ADAMAH_ERR_INVALID;
    adamah_Map* m = &g_ctx.maps[id];
    vkWaitForFences(g_ctx.device, 1, &m->fence, VK_TRUE, UINT64_MAX);
    vkDestroyFence(g_ctx.device, m->fence, NULL);
    destroy_buffer(&m->data);
    destroy_buffer(&m->gpu_locs);
    destroy_buffer(&m->gpu_vals);
    memset(m, 0, sizeof(*m));
    return ADAMAH_OK;
}

int map_clear(uint32_t id) {
    if (!g_ctx.initialized || id >= ADAMAH_MAX_MAPS || !g_ctx.maps[id].active) return ADAMAH_ERR_INVALID;
    adamah_Map* m = &g_ctx.maps[id];
    vkWaitForFences(g_ctx.device, 1, &m->fence, VK_TRUE, UINT64_MAX);
    memset(m->data.ptr, 0, m->total_bytes);
    return ADAMAH_OK;
}

uint64_t map_limit(uint32_t id) {
    if (!g_ctx.initialized || id >= ADAMAH_MAX_MAPS || !g_ctx.maps[id].active) return 0;
    return g_ctx.maps[id].total_elems - 1;
}

int mscatter(uint32_t id, const uint64_t* locs, const void* vals, uint32_t count) {
    if (!g_ctx.initialized || id >= ADAMAH_MAX_MAPS || !g_ctx.maps[id].active || !locs || !vals || !count) return ADAMAH_ERR_INVALID;
    adamah_Map* m = &g_ctx.maps[id];
    vkWaitForFences(g_ctx.device, 1, &m->fence, VK_TRUE, UINT64_MAX);
    
    uint32_t wpe = m->word_size / 4;
    uint32_t idx = wpe - 1;
    
    for (uint32_t off = 0; off < count; off += m->pack_size) {
        uint32_t batch = (count - off > m->pack_size) ? m->pack_size : count - off;
        
        for (uint32_t i = 0; i < batch; i++) ((uint32_t*)m->gpu_locs.ptr)[i*2] = (uint32_t)locs[off+i];
        memcpy(m->gpu_vals.ptr, (const char*)vals + off * m->word_size, batch * m->word_size);
        
        vkResetFences(g_ctx.device, 1, &m->fence);
        vkResetCommandBuffer(m->cmd, 0);
        VkCommandBufferBeginInfo cbbi = { .sType = VK_STRUCTURE_TYPE_COMMAND_BUFFER_BEGIN_INFO };
        vkBeginCommandBuffer(m->cmd, &cbbi);
        vkCmdBindPipeline(m->cmd, VK_PIPELINE_BIND_POINT_COMPUTE, g_ctx.pipelines[idx].scatter);
        vkCmdBindDescriptorSets(m->cmd, VK_PIPELINE_BIND_POINT_COMPUTE, g_ctx.pipe_layout, 0, 1, &m->desc_scatter, 0, NULL);
        vkCmdPushConstants(m->cmd, g_ctx.pipe_layout, VK_SHADER_STAGE_COMPUTE_BIT, 0, sizeof(uint32_t), &batch);
        vkCmdDispatch(m->cmd, (batch + LOCAL_SIZE - 1) / LOCAL_SIZE, 1, 1);
        vkEndCommandBuffer(m->cmd);
        VkSubmitInfo si = { .sType = VK_STRUCTURE_TYPE_SUBMIT_INFO, .commandBufferCount = 1, .pCommandBuffers = &m->cmd };
        vkQueueSubmit(g_ctx.queue, 1, &si, m->fence);
        vkWaitForFences(g_ctx.device, 1, &m->fence, VK_TRUE, UINT64_MAX);
    }
    return ADAMAH_OK;
}

int mgather(uint32_t id, const uint64_t* locs, void* out, uint32_t count) {
    if (!g_ctx.initialized || id >= ADAMAH_MAX_MAPS || !g_ctx.maps[id].active || !locs || !out || !count) return ADAMAH_ERR_INVALID;
    adamah_Map* m = &g_ctx.maps[id];
    vkWaitForFences(g_ctx.device, 1, &m->fence, VK_TRUE, UINT64_MAX);
    
    uint32_t wpe = m->word_size / 4;
    uint32_t idx = wpe - 1;
    
    for (uint32_t off = 0; off < count; off += m->pack_size) {
        uint32_t batch = (count - off > m->pack_size) ? m->pack_size : count - off;
        
        for (uint32_t i = 0; i < batch; i++) ((uint32_t*)m->gpu_locs.ptr)[i*2] = (uint32_t)locs[off+i];
        
        vkResetFences(g_ctx.device, 1, &m->fence);
        vkResetCommandBuffer(m->cmd, 0);
        VkCommandBufferBeginInfo cbbi = { .sType = VK_STRUCTURE_TYPE_COMMAND_BUFFER_BEGIN_INFO };
        vkBeginCommandBuffer(m->cmd, &cbbi);
        vkCmdBindPipeline(m->cmd, VK_PIPELINE_BIND_POINT_COMPUTE, g_ctx.pipelines[idx].gather);
        vkCmdBindDescriptorSets(m->cmd, VK_PIPELINE_BIND_POINT_COMPUTE, g_ctx.pipe_layout, 0, 1, &m->desc_gather, 0, NULL);
        vkCmdPushConstants(m->cmd, g_ctx.pipe_layout, VK_SHADER_STAGE_COMPUTE_BIT, 0, sizeof(uint32_t), &batch);
        vkCmdDispatch(m->cmd, (batch + LOCAL_SIZE - 1) / LOCAL_SIZE, 1, 1);
        vkEndCommandBuffer(m->cmd);
        VkSubmitInfo si = { .sType = VK_STRUCTURE_TYPE_SUBMIT_INFO, .commandBufferCount = 1, .pCommandBuffers = &m->cmd };
        vkQueueSubmit(g_ctx.queue, 1, &si, m->fence);
        vkWaitForFences(g_ctx.device, 1, &m->fence, VK_TRUE, UINT64_MAX);
        
        memcpy((char*)out + off * m->word_size, m->gpu_vals.ptr, batch * m->word_size);
    }
    return ADAMAH_OK;
}

int map_save(uint32_t id, const char* path) {
    if (!g_ctx.initialized || id >= ADAMAH_MAX_MAPS || !g_ctx.maps[id].active || !path) return ADAMAH_ERR_INVALID;
    adamah_Map* m = &g_ctx.maps[id];
    vkWaitForFences(g_ctx.device, 1, &m->fence, VK_TRUE, UINT64_MAX);
    FILE* f = fopen(path, "wb");
    if (!f) return ADAMAH_ERR_INVALID;
    size_t w = fwrite(m->data.ptr, 1, m->total_bytes, f);
    fclose(f);
    return (w == m->total_bytes) ? ADAMAH_OK : ADAMAH_ERR_INVALID;
}

int map_load(uint32_t id, const char* path) {
    if (!g_ctx.initialized || id >= ADAMAH_MAX_MAPS || !g_ctx.maps[id].active || !path) return ADAMAH_ERR_INVALID;
    adamah_Map* m = &g_ctx.maps[id];
    vkWaitForFences(g_ctx.device, 1, &m->fence, VK_TRUE, UINT64_MAX);
    FILE* f = fopen(path, "rb");
    if (!f) return ADAMAH_ERR_INVALID;
    size_t r = fread(m->data.ptr, 1, m->total_bytes, f);
    fclose(f);
    return (r == m->total_bytes) ? ADAMAH_OK : ADAMAH_ERR_INVALID;
}

// ============================================
// Vector Buffers
// ============================================

int vbuf_alloc(uint32_t id, uint32_t n_floats) {
    if (!g_ctx.initialized || id >= ADAMAH_MAX_VBUFS) return ADAMAH_ERR_INVALID;
    if (g_ctx.vbufs[id].buf) return ADAMAH_ERR_EXISTS;
    if (!n_floats) return ADAMAH_ERR_INVALID;
    
    adamah_VBuf* v = &g_ctx.vbufs[id];
    VkDeviceSize size = n_floats * sizeof(float);
    
    VkBufferCreateInfo bci = { .sType = VK_STRUCTURE_TYPE_BUFFER_CREATE_INFO, .size = size, 
        .usage = VK_BUFFER_USAGE_STORAGE_BUFFER_BIT | VK_BUFFER_USAGE_TRANSFER_SRC_BIT | VK_BUFFER_USAGE_TRANSFER_DST_BIT };
    if (vkCreateBuffer(g_ctx.device, &bci, NULL, &v->buf) != VK_SUCCESS) return ADAMAH_ERR_VULKAN;
    
    VkMemoryRequirements reqs;
    vkGetBufferMemoryRequirements(g_ctx.device, v->buf, &reqs);
    uint32_t mtype = find_memory_type(reqs.memoryTypeBits, VK_MEMORY_PROPERTY_HOST_VISIBLE_BIT | VK_MEMORY_PROPERTY_HOST_COHERENT_BIT);
    if (mtype == UINT32_MAX) { vkDestroyBuffer(g_ctx.device, v->buf, NULL); v->buf = VK_NULL_HANDLE; return ADAMAH_ERR_MEMORY; }
    
    VkMemoryAllocateInfo mai = { .sType = VK_STRUCTURE_TYPE_MEMORY_ALLOCATE_INFO, .allocationSize = reqs.size, .memoryTypeIndex = mtype };
    if (vkAllocateMemory(g_ctx.device, &mai, NULL, &v->mem) != VK_SUCCESS) { vkDestroyBuffer(g_ctx.device, v->buf, NULL); v->buf = VK_NULL_HANDLE; return ADAMAH_ERR_MEMORY; }
    
    vkBindBufferMemory(g_ctx.device, v->buf, v->mem, 0);
    vkMapMemory(g_ctx.device, v->mem, 0, size, 0, &v->ptr);
    v->size = n_floats;
    memset(v->ptr, 0, size);
    return ADAMAH_OK;
}

int vbuf_free(uint32_t id) {
    if (!g_ctx.initialized || id >= ADAMAH_MAX_VBUFS) return ADAMAH_ERR_INVALID;
    adamah_VBuf* v = &g_ctx.vbufs[id];
    if (!v->buf) return ADAMAH_ERR_NOT_FOUND;
    if (v->ptr) vkUnmapMemory(g_ctx.device, v->mem);
    if (v->buf) vkDestroyBuffer(g_ctx.device, v->buf, NULL);
    if (v->mem) vkFreeMemory(g_ctx.device, v->mem, NULL);
    memset(v, 0, sizeof(*v));
    return ADAMAH_OK;
}

int vbuf_upload(uint32_t id, const float* data, uint32_t offset, uint32_t count) {
    if (!g_ctx.initialized || id >= ADAMAH_MAX_VBUFS || !g_ctx.vbufs[id].buf || !data) return ADAMAH_ERR_INVALID;
    if (offset + count > g_ctx.vbufs[id].size) return ADAMAH_ERR_BOUNDS;
    memcpy((float*)g_ctx.vbufs[id].ptr + offset, data, count * sizeof(float));
    return ADAMAH_OK;
}

int vbuf_download(uint32_t id, float* data, uint32_t offset, uint32_t count) {
    if (!g_ctx.initialized || id >= ADAMAH_MAX_VBUFS || !g_ctx.vbufs[id].buf || !data) return ADAMAH_ERR_INVALID;
    if (offset + count > g_ctx.vbufs[id].size) return ADAMAH_ERR_BOUNDS;
    memcpy(data, (float*)g_ctx.vbufs[id].ptr + offset, count * sizeof(float));
    return ADAMAH_OK;
}

int vbuf_zero(uint32_t id, uint32_t offset, uint32_t count) {
    if (!g_ctx.initialized || id >= ADAMAH_MAX_VBUFS || !g_ctx.vbufs[id].buf) return ADAMAH_ERR_INVALID;
    if (offset + count > g_ctx.vbufs[id].size) return ADAMAH_ERR_BOUNDS;
    memset((float*)g_ctx.vbufs[id].ptr + offset, 0, count * sizeof(float));
    return ADAMAH_OK;
}

uint32_t vbuf_size(uint32_t id) {
    if (!g_ctx.initialized || id >= ADAMAH_MAX_VBUFS) return 0;
    return g_ctx.vbufs[id].size;
}

// ============================================
// Vector Math (GPU accelerated)
// ============================================

static inline float* vptr(uint32_t id) { return g_ctx.vbufs[id].buf ? (float*)g_ctx.vbufs[id].ptr : NULL; }

static int dispatch_math_op(VkPipeline pipe, uint32_t dst, uint32_t src_a, uint32_t src_b, uint32_t count, uint32_t op) {
    vkWaitForFences(g_ctx.device, 1, &g_ctx.fence, VK_TRUE, UINT64_MAX);
    
    VkDescriptorSet desc;
    VkDescriptorSetAllocateInfo dsai = { .sType = VK_STRUCTURE_TYPE_DESCRIPTOR_SET_ALLOCATE_INFO, .descriptorPool = g_ctx.desc_pool, .descriptorSetCount = 1, .pSetLayouts = &g_ctx.desc_layout_math };
    if (vkAllocateDescriptorSets(g_ctx.device, &dsai, &desc) != VK_SUCCESS) return ADAMAH_ERR_VULKAN;
    
    VkDescriptorBufferInfo dst_info = { g_ctx.vbufs[dst].buf, 0, VK_WHOLE_SIZE };
    VkDescriptorBufferInfo a_info = { g_ctx.vbufs[src_a].buf, 0, VK_WHOLE_SIZE };
    VkDescriptorBufferInfo b_info = { src_b < ADAMAH_MAX_VBUFS && g_ctx.vbufs[src_b].buf ? g_ctx.vbufs[src_b].buf : g_ctx.vbufs[src_a].buf, 0, VK_WHOLE_SIZE };
    
    VkWriteDescriptorSet writes[3] = {
        { .sType = VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET, .dstSet = desc, .dstBinding = 0, .descriptorCount = 1, .descriptorType = VK_DESCRIPTOR_TYPE_STORAGE_BUFFER, .pBufferInfo = &dst_info },
        { .sType = VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET, .dstSet = desc, .dstBinding = 1, .descriptorCount = 1, .descriptorType = VK_DESCRIPTOR_TYPE_STORAGE_BUFFER, .pBufferInfo = &a_info },
        { .sType = VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET, .dstSet = desc, .dstBinding = 2, .descriptorCount = 1, .descriptorType = VK_DESCRIPTOR_TYPE_STORAGE_BUFFER, .pBufferInfo = &b_info },
    };
    vkUpdateDescriptorSets(g_ctx.device, 3, writes, 0, NULL);
    
    uint32_t push[2] = { count, op };
    
    vkResetFences(g_ctx.device, 1, &g_ctx.fence);
    vkResetCommandBuffer(g_ctx.cmd, 0);
    VkCommandBufferBeginInfo cbbi = { .sType = VK_STRUCTURE_TYPE_COMMAND_BUFFER_BEGIN_INFO };
    vkBeginCommandBuffer(g_ctx.cmd, &cbbi);
    vkCmdBindPipeline(g_ctx.cmd, VK_PIPELINE_BIND_POINT_COMPUTE, pipe);
    vkCmdBindDescriptorSets(g_ctx.cmd, VK_PIPELINE_BIND_POINT_COMPUTE, g_ctx.pipe_layout_math, 0, 1, &desc, 0, NULL);
    vkCmdPushConstants(g_ctx.cmd, g_ctx.pipe_layout_math, VK_SHADER_STAGE_COMPUTE_BIT, 0, sizeof(push), push);
    vkCmdDispatch(g_ctx.cmd, (count + LOCAL_SIZE - 1) / LOCAL_SIZE, 1, 1);
    vkEndCommandBuffer(g_ctx.cmd);
    
    VkSubmitInfo si = { .sType = VK_STRUCTURE_TYPE_SUBMIT_INFO, .commandBufferCount = 1, .pCommandBuffers = &g_ctx.cmd };
    vkQueueSubmit(g_ctx.queue, 1, &si, g_ctx.fence);
    vkWaitForFences(g_ctx.device, 1, &g_ctx.fence, VK_TRUE, UINT64_MAX);
    
    return ADAMAH_OK;
}

int vop2(uint32_t op, uint32_t dst, uint32_t a, uint32_t b, uint32_t count) {
    if (!g_ctx.initialized) return ADAMAH_ERR_INVALID;
    if (dst >= ADAMAH_MAX_VBUFS || a >= ADAMAH_MAX_VBUFS || b >= ADAMAH_MAX_VBUFS) return ADAMAH_ERR_INVALID;
    if (!g_ctx.vbufs[dst].buf || !g_ctx.vbufs[a].buf || !g_ctx.vbufs[b].buf) return ADAMAH_ERR_NOT_FOUND;
    return dispatch_math_op(g_ctx.pipe_binary, dst, a, b, count, op);
}

int vop_scalar(uint32_t op, uint32_t dst, uint32_t a, float scalar, uint32_t count) {
    if (!g_ctx.initialized || dst >= ADAMAH_MAX_VBUFS || a >= ADAMAH_MAX_VBUFS) return ADAMAH_ERR_INVALID;
    float* pd = vptr(dst); float* pa = vptr(a);
    if (!pd || !pa) return ADAMAH_ERR_NOT_FOUND;
    // CPU fallback for scalar ops
    switch (op) {
        case VOP_ADD: for (uint32_t i = 0; i < count; i++) pd[i] = pa[i] + scalar; break;
        case VOP_SUB: for (uint32_t i = 0; i < count; i++) pd[i] = pa[i] - scalar; break;
        case VOP_MUL: for (uint32_t i = 0; i < count; i++) pd[i] = pa[i] * scalar; break;
        case VOP_DIV: for (uint32_t i = 0; i < count; i++) pd[i] = pa[i] / scalar; break;
        default: return ADAMAH_ERR_INVALID;
    }
    return ADAMAH_OK;
}

int vop1(uint32_t op, uint32_t dst, uint32_t a, uint32_t count) {
    if (!g_ctx.initialized) return ADAMAH_ERR_INVALID;
    if (dst >= ADAMAH_MAX_VBUFS || a >= ADAMAH_MAX_VBUFS) return ADAMAH_ERR_INVALID;
    if (!g_ctx.vbufs[dst].buf || !g_ctx.vbufs[a].buf) return ADAMAH_ERR_NOT_FOUND;
    return dispatch_math_op(g_ctx.pipe_unary, dst, a, a, count, op);
}

int vreduce(uint32_t op, uint32_t dst, uint32_t a, uint32_t count) {
    if (!g_ctx.initialized || dst >= ADAMAH_MAX_VBUFS || a >= ADAMAH_MAX_VBUFS) return ADAMAH_ERR_INVALID;
    if (!g_ctx.vbufs[dst].buf || !g_ctx.vbufs[a].buf) return ADAMAH_ERR_NOT_FOUND;
    // GPU reduce for large, CPU for small
    if (count > 256) {
        return dispatch_math_op(g_ctx.pipe_reduce, dst, a, a, count, op);
    }
    float* pd = vptr(dst); float* pa = vptr(a);
    float result = pa[0];
    switch (op) {
        case VRED_SUM: result = 0; for (uint32_t i = 0; i < count; i++) result += pa[i]; break;
        case VRED_MAX: for (uint32_t i = 1; i < count; i++) if (pa[i] > result) result = pa[i]; break;
        case VRED_MIN: for (uint32_t i = 1; i < count; i++) if (pa[i] < result) result = pa[i]; break;
    }
    pd[0] = result;
    return ADAMAH_OK;
}

int vdot(uint32_t dst, uint32_t a, uint32_t b, uint32_t count) {
    if (!g_ctx.initialized || dst >= ADAMAH_MAX_VBUFS || a >= ADAMAH_MAX_VBUFS || b >= ADAMAH_MAX_VBUFS) return ADAMAH_ERR_INVALID;
    float* pd = vptr(dst); float* pa = vptr(a); float* pb = vptr(b);
    if (!pd || !pa || !pb) return ADAMAH_ERR_NOT_FOUND;
    float sum = 0;
    for (uint32_t i = 0; i < count; i++) sum += pa[i] * pb[i];
    pd[0] = sum;
    return ADAMAH_OK;
}

int vfma(uint32_t dst, uint32_t a, uint32_t b, uint32_t c, uint32_t count) {
    if (!g_ctx.initialized) return ADAMAH_ERR_INVALID;
    float* pd = vptr(dst); float* pa = vptr(a); float* pb = vptr(b); float* pc = vptr(c);
    if (!pd || !pa || !pb || !pc) return ADAMAH_ERR_NOT_FOUND;
    for (uint32_t i = 0; i < count; i++) pd[i] = pa[i] * pb[i] + pc[i];
    return ADAMAH_OK;
}

int vsoftmax(uint32_t buf, uint32_t offset, uint32_t count) {
    if (!g_ctx.initialized || buf >= ADAMAH_MAX_VBUFS || !g_ctx.vbufs[buf].buf) return ADAMAH_ERR_INVALID;
    if (offset + count > g_ctx.vbufs[buf].size) return ADAMAH_ERR_BOUNDS;
    float* p = vptr(buf) + offset;
    float max_val = p[0];
    for (uint32_t i = 1; i < count; i++) if (p[i] > max_val) max_val = p[i];
    float sum = 0;
    for (uint32_t i = 0; i < count; i++) { p[i] = expf(p[i] - max_val); sum += p[i]; }
    float inv = 1.0f / sum;
    for (uint32_t i = 0; i < count; i++) p[i] *= inv;
    return ADAMAH_OK;
}

int vmatvec(uint32_t dst, uint32_t mat, uint32_t vec, uint32_t rows, uint32_t cols) {
    if (!g_ctx.initialized) return ADAMAH_ERR_INVALID;
    float* pd = vptr(dst); float* pm = vptr(mat); float* pv = vptr(vec);
    if (!pd || !pm || !pv) return ADAMAH_ERR_NOT_FOUND;
    for (uint32_t i = 0; i < rows; i++) {
        float sum = 0;
        for (uint32_t j = 0; j < cols; j++) sum += pm[i * cols + j] * pv[j];
        pd[i] = sum;
    }
    return ADAMAH_OK;
}
